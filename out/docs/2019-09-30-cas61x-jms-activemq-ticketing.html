<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---ticket-distribution-with-jmssummary----learn-to-configure-apereo-cas-to-jms-and-messages-queues-to-broadcast-tickets-and-tokens-across-a-deployment-clustertags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---ticket-distribution-with-jmssummary----learn-to-configure-apereo-cas-to-jms-and-messages-queues-to-broadcast-tickets-and-tokens-across-a-deployment-clustertags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Ticket Distribution with JMS<br>
summary:    Learn to configure Apereo CAS to JMS and messages queues to broadcast tickets and tokens across a deployment cluster.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>CAS can be enabled with a variety of messaging systems to distribute and share ticket data: from simplified use of the JMS API to a complete infrastructure to receive messages asynchronously. This is the capability where CAS uses a specialized form of the default in-memory ticket registry with the main difference that ticket operations applied to the registry are broadcasted using a messaging queue to other listening CAS nodes on the queue. Each node keeps copies of ticket state on its own and only instructs others to keep their copy accurate by broadcasting messages and data associated with each. Each message and ticket registry instance running inside a CAS node in the cluster is tagged with a unique identifier to avoid endless looping behavior and recursive needless inbound operations.</p>
<p>In this tutorial, we are going to briefly review the JMS configuration in Apereo CAS and steps required to use message queues to <a href="https://apereo.github.io/cas/development/ticketing/Messaging-JMS-Ticket-Registry.html">distribute tickets and tokens</a> across a cluster. Our starting position is based on:</p>
<ul>
<li>CAS <code>6.1.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
<li>Docker</li>
</ul>
<h1>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h1>
<h2>
<a id="activemq" class="anchor" href="#activemq" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ActiveMQ</h2>
<p>We are going to be using ActiveMQ as our message broker whose job is to act as a hub and distribute tickets to subscribers. The quickest way to bring up ActiveMQ would be using the following command:</p>
<pre lang="bash"><code>docker run -d --name activemq-server -p 61616:61616 -p 8161:8161 rmohr/activemq
</code></pre>
<p>That should be all, for now.</p>
<h2>
<a id="cas" class="anchor" href="#cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CAS</h2>
<p>Once you have prepped your CAS overlay with the correct <a href="https://apereo.github.io/cas/development/ticketing/Messaging-JMS-Ticket-Registry.html">auto-configuration module</a>, you will need to instruct CAS to try and connect to ActiveMQ for which you will need, at a minimum, the following settings:</p>
<pre lang="properties"><code>spring.activemq.broker-url=tcp://localhost:61616
spring.activemq.user=admin
spring.activemq.password=admin
</code></pre>
<h2>
<a id="test" class="anchor" href="#test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test</h2>
<p>Let's bring up a CAS server node on port <code>8444</code>:</p>
<pre lang="bash"><code>java -jar build/libs/cas.war --server.port=8444
</code></pre>
<p>...and then, let's bring up another on port <code>8445</code>:</p>
<pre lang="bash"><code>java -jar build/libs/cas.war --server.port=8445
</code></pre>
<p>In the CAS logs, you should be able to notice the following statements:</p>
<pre lang="bash"><code>&lt;Established shared JMS Connection: ActiveMQConnection {id=ID:misaghmoayyed.local-65269-1569759674508-1:1,clientId=null,started=false}&gt;
....
&lt;Configuring JMS ticket registry with identifier [JmsTicketRegistryQueueIdentifier(id=d6b0927b-5c08-4c97-b0aa-02d5d8e709f5)]&gt;
</code></pre>
<p>At this point, you should be able to access <code>https://localhost:8445/cas/login</code> and attempt to login. Once you have successfully authenticated, you should observe the distribution of tickets in the CAS logs from one node to the other.</p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please know that all other use cases, scenarios, features, and theories certainly <a href="https://apereo.github.io/2017/02/18/onthe-theoryof-possibility/">are possible</a> as well. Feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>