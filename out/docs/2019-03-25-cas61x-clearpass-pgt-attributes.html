<hr>
<p>layout:     post<br>
title:      Apereo CAS 6.1.x - Credential Caching &amp; Proxy AuthN<br>
summary:    Learn how you may configure Apereo CAS to capture and cache the credential's password and the proxy-granting ticket in proxy authentication scenarios, pass them along to applications as regular attributes/claims. We will also be reviewing a handful of attribute release strategies that specifically affect authentication attributes, conveying metadata about the authentication event itself.</p>
<h2>
<a id="tags-------cas" class="anchor" href="#tags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>Authentication attributes in CAS are defined separately from principal attributes. They capture and convey additional information, or <em>metadata</em> if you prefer, about the authentication transaction itself. Examples would include attributes such as <em>What time did this authentication attempt occur?</em>, or <em>What type of credentials were used for authentication?</em>, etc. This collection of attributes may also be enhanced via each authentication protocol such as CAS, OpenID Connect, SAML, etc to include even more protocol-specific details.</p>
<!-- raw HTML omitted -->
<p>An attractive candidate as an authentication attributes is the <code>proxyGrantingTicket</code> attribute that of course plays a key role in CAS <a href="https://apereo.github.io/cas/development/installation/Configuring-Proxy-Authentication.html">proxy authentication</a> scenarios. When dealing with proxied authentication attempts, invoking a callback URL to receive the proxy granting ticket may not be all too desirable especially if the proxied application itself is clustered. In such scenarios, CAS may be configured to return the proxy granting ticket directly in the validation response as an authentication attribute. In order to successfully establish trust between the CAS server and the application, private/public key pairs are generated by the client application and then the public key distributed and configured inside CAS. CAS will use the public key to encrypt the proxy granting ticket id and will issue a new attribute in the validation response, only if the service is authorized to receive it.</p>
<p>Another interesting candidate is the capturing and caching of user's credential to be passed along as an authentication attribute. CAS historically came out with this feature, so named <a href="https://apereo.github.io/cas/development/integration/ClearPass.html">ClearPass</a>, that was very much built on top of proxy authentication capabilities. The original ClearPass idea, developed as an extension outside of CAS, was that an application may obtain cleartext credentials for an authenticated user by presenting a valid proxy ticket obtained specifically for the CAS cleartext extension service endpoint. To simplify this process, newer CAS versions begin to capture and release the credential as an authentication attribute, removing the need for callbacks and proxy authentication. Just as before, in order to successfully establish trust between the CAS server and the application, private/public key pairs are generated by the client application and then the public key distributed and configured inside CAS. CAS will use the public key to encrypt the credential password and will issue a new attribute in the validation response, only if the service is authorized to receive it.</p>
<p>In this post, we will be reviewing a few strategies to release proxy-granting tickets to applications. We will also be reviewing the configuration required to make ClearPass work and may briefly touch upon release strategies that affect authentication attributes in general.</p>
<p>Our starting position is based on:</p>
<ul>
<li>CAS <code>6.1.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
<li><a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON Service Registry</a></li>
</ul>
<h2>
<a id="proxy-granting-tickets" class="anchor" href="#proxy-granting-tickets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Proxy-granting Tickets</h2>
<p>To release the proxy-granting ticket to an application as an attribute, we need to establish trust between the CAS server and the application, using private/public key pairs generated by the client application. CAS will use the public key to encrypt the proxy granting ticket id and will issue a new attribute in the validation response, only if the service is authorized to receive it.</p>
<!-- raw HTML omitted -->
<p>Once you have generated the key pair, the service definition for the application authorized to receive the proxy-granting ticket may look like this:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^https://sample.example.org:9443/sample.*",
  "name" : "Sample",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy",
    "authorizedToReleaseProxyGrantingTicket" : true
  },
  "publicKey" : {
    "@class" : "org.apereo.cas.services.RegisteredServicePublicKeyImpl",
    "location" : "file:/etc/cas/config/clearpass/public.key"
  },
  "proxyPolicy" : {
    "@class" : "org.apereo.cas.services.RegexMatchingRegisteredServiceProxyPolicy",
    "pattern" : "^https://sample.example.org:9443/sample/.+"
  }
}
</code></pre>
<p>Note the <code>proxyPolicy</code> block which controls whether the application is allowed to exercise proxy authentication in general. Per the docs:</p>
<blockquote>
<p>Each registered application in the registry may be assigned a proxy policy to determine whether the service is allowed for proxy authentication. This means that a PGT will not be issued to a service unless the proxy policy is configured to allow it. Additionally, the policy could also define which endpoint URLs are in fact allowed to receive the PGT.</p>
</blockquote>
<p>Once the public key is taught to CAS using the <code>publicKey</code> block, the only thing that remains is the <code>authorizedToReleaseProxyGrantingTicket</code> switch which controls the release of the proxy-granting ticket as an attribute encapsulated inside the service's attribute release policy.</p>
<h3>
<a id="test" class="anchor" href="#test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test</h3>
<p>If you run through the application, you should ultimately expect the following attributes in the CAS response:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/54905205-ab2a0300-4e9d-11e9-9c5e-3ae1be5fdd06.png" alt="image"></p>
<h2>
<a id="clearpass" class="anchor" href="#clearpass" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ClearPass</h2>
<p>Configuring CAS to release the credential password as an attribute is very similar. As the first step, we will enable and assign encryption and signing keys to ClearPass in order to capture the password and encrypt it while cached in memory so as to not leak the plaintext password in case data and memory are compromised or somehow shared externally.</p>
<pre lang="properties"><code>cas.clearpass.cacheCredential=true
cas.clearpass.crypto.encryption.key=AZ5y...
cas.clearpass.crypto.signing.key=cAPyo...
</code></pre>
<p>Once that's done, we can just enable the application to receive the password using the <code>authorizedToReleaseCredentialPassword</code> switch:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "^https://sample.example.org:9443/sample.*",
  "name" : "Sample",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllowedAttributeReleasePolicy",
    "authorizedToReleaseProxyGrantingTicket" : true,
    "authorizedToReleaseCredentialPassword" : true
  },
  "publicKey" : {
    "@class" : "org.apereo.cas.services.RegisteredServicePublicKeyImpl",
    "location" : "file:/etc/cas/config/clearpass/public.key"
  },
  "proxyPolicy" : {
    "@class" : "org.apereo.cas.services.RegexMatchingRegisteredServiceProxyPolicy",
    "pattern" : "^https://sample.example.org:9443/sample/.+"
  }
}
</code></pre>
<h3>
<a id="test-1" class="anchor" href="#test-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test</h3>
<p>If you run through the application, you should ultimately expect the following attributes in the CAS response:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/54905561-94d07700-4e9e-11e9-8a5b-b4ff2d26c646.png" alt="image"></p>
<h2>
<a id="authentication-attributes" class="anchor" href="#authentication-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authentication Attributes</h2>
<p>There are of course many other types of attributes that could be collected as part of the authentication event itself. The release of such attributes to applications is controlled globally via CAS settings. For example, you can decide to never release any authentication-level attributes to any applications:</p>
<pre lang="properties"><code>cas.authn.authenticationAttributeRelease.enabled=false
</code></pre>
<p>Or let's say that you only prefer to send a handful of authentication attributes to all applications:</p>
<pre lang="properties"><code>cas.authn.authenticationAttributeRelease.enabled=false
cas.authn.authenticationAttributeRelease.neverRelease=credentialType,authenticationDate
</code></pre>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please know that all other use cases, scenarios, features, and theories certainly <a href="https://apereo.github.io/2017/02/18/onthe-theoryof-possibility/">are possible</a> as well. Feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>