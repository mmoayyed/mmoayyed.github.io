<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---handling-multiple-logout-urlssummary----extend-the-apereo-cas-server-to-allow-for-multiple-logout-urls-during-slo-operationstags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---handling-multiple-logout-urlssummary----extend-the-apereo-cas-server-to-allow-for-multiple-logout-urls-during-slo-operationstags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Handling Multiple Logout URLs<br>
summary:    Extend the Apereo CAS server to allow for multiple logout URLs during SLO operations.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>CAS has had <a href="https://apereo.github.io/cas/development/installation/Logout-Single-Signout.html">support for single logout</a> for quite a while. This feature basically means that CAS is able to invalidate client application sessions in addition to its own SSO session, assuming client applications are ready to honor and accept logout requests with special configuration. When a CAS session ends, it notifies each of the services that the SSO session is no longer valid, and that relying parties need to invalidate their own session by processing a special logout request. Remember that the callback submitted to each CAS-protected application is simply <em>a notification</em>; nothing more. It is the <em>responsibility of the application</em> to intercept that notification and properly destroy the user authentication session, either manually, via a specific endpoint or more commonly via a CAS client library that supports SLO.</p>
<p>By default, applications are contacted by CAS using their <em>original URL</em> to receive the logout notification; which is simply the purified service URL used when an authentication request on behalf of the application is submitted to CAS. This tutorial focuses on ways one can customize the logout URL in more dynamic ways.</p>
<p>This tutorial deals with:</p>
<ul>
<li>CAS <code>5.3.0-RC4</code>
</li>
<li>Java 8</li>
<li>
<a href="https://github.com/apereo/cas-overlay-template">Maven</a> Or <a href="https://github.com/apereo/cas-gradle-overlay-template">Gradle</a> WAR Overlays</li>
<li><a href="https://apereo.github.io/cas/development/installation/Logout-Single-Signout.html">Single Logout</a></li>
</ul>
<h1>
<a id="single-logout-url" class="anchor" href="#single-logout-url" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Single Logout URL</h1>
<p>In dealing with single logout operations, the URL endpoint to receive the logout notification can be customized on a per-application basis:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://\\w+.example.org",
  "name" : "Our Example Domain",
  "id" : 1,
  "description" : "The example domain provides examples in examplish ways",
  "logoutUrl" : "https://logout.example.org"
}
</code></pre>
<p>This is, of course, the simplest option and means that if CAS has established sessions with one or more applications that qualify for the above definition, those applications will receive logout notifications at the specified URL above when the logout engine in CAS begins to process records.</p>
<h1>
<a id="many-logout-urls" class="anchor" href="#many-logout-urls" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Many Logout URLs</h1>
<p>One should note that the <code>logoutUrl</code> above not only static but also singular. With configuration only, there is not a way for one to specify more than one URL in cases where that might be needed. While the service configuration above presents a rather simplified version of the feature, CAS itself provides the internal mechanics to recognize and handle a collection of logout URLs for a given application. Our task here would be to extend the configuration slightly to implement this scenario and inject the behavior into the runtime.</p>
<p>We can start by preparing CAS with a <a href="https://apereo.github.io/cas/development/installation/Configuration-Management-Extensions.html">customized configuration component</a> that would house our customizations for this use case. Once that is done, take note of the following bean definition posted in <code>CasCoreLogoutConfiguration.java</code> today:</p>
<pre lang="java"><code>@ConditionalOnMissingBean(name = "singleLogoutServiceLogoutUrlBuilder")
@Bean
public SingleLogoutServiceLogoutUrlBuilder singleLogoutServiceLogoutUrlBuilder() {
    return new DefaultSingleLogoutServiceLogoutUrlBuilder(this.urlValidator);
}
</code></pre>
<p>Note how the bean is marked as conditional, meaning it will only be used by CAS if an alternative definition by the same is <em>not</em> found. So, in order for CAS to pick up our own alternative implementation, we are going to provide that bean definition in our own configuration class as such:</p>
<pre lang="java"><code>@Bean
public SingleLogoutServiceLogoutUrlBuilder singleLogoutServiceLogoutUrlBuilder() {
    return new CustomSingleLogoutServiceLogoutUrlBuilder(this.urlValidator);
}
</code></pre>
<!-- raw HTML omitted -->
<p>Now, it's time to actually design our very own <code>CustomSingleLogoutServiceLogoutUrlBuilder</code>. Here is a modest example:</p>
<pre lang="java"><code>public class CustomSingleLogoutServiceLogoutUrlBuilder extends DefaultSingleLogoutServiceLogoutUrlBuilder {

    ...
    public Collection&lt;URL&gt; determineLogoutUrl(RegisteredService registeredService, WebApplicationService service) {

        /*
            Stuff happens to determine the collection of the logout URLs
            given the provided service and its registered definition in the registry.
        */
    }

}
</code></pre>
<p>That should do it. The very next time you build and deploy the changes, CAS should pick up our own bean definition and accompanying implementation class. It should be obvious that inside the class above, you have options to calculate the logout URLs as you wish since the builder object is expected to return a collection of URLs. To fully make this behavior dynamic, you may want to invest time researching <a href="https://apereo.github.io/cas/development/installation/Configuring-Service-Custom-Properties.html">service custom properties</a> and externalize the logout function with special tags designed as properties that would then be consumed and processed in the above component.</p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>