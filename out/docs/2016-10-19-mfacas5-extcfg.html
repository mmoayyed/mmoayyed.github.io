<hr>
<h2>
<a id="layout-----posttitle------activating-mfa-in-cas-5summary----learn-and-master-custom-mfa-triggers-in-cas-5tags-------casmfa" class="anchor" href="#layout-----posttitle------activating-mfa-in-cas-5summary----learn-and-master-custom-mfa-triggers-in-cas-5tags-------casmfa" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Activating MFA in CAS 5<br>
summary:    Learn and master custom MFA triggers in CAS 5.<br>
tags:       [CAS,MFA]</h2>
<!-- raw HTML omitted -->
<p>Perhaps one of the more attractive features of <a href="https://apereo.github.io/cas/development">CAS 5</a> is the ability to support <a href="https://apereo.github.io/cas/development/installation/Configuring-Multifactor-Authentication.html">multifactor authentication</a><br>
via a number of providers/vendors that can be triggered in many ways. While support for triggers may seem extensive, there is always<br>
that edge use case that would have you trigger MFA based on a special set of requirements.</p>
<p>Here is what you can do.</p>
<h1>
<a id="audience" class="anchor" href="#audience" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Audience</h1>
<p>This post is intended for java developers with a basic-to-medium familiarity with Spring, Spring Boot and Spring Webflow.<br>
This is <strong>NOT</strong> a tutorial to be used verbatim via copy/paste. It is instead a recipe for developers to extend CAS<br>
based on specialized requirements.</p>
<h1>
<a id="stop-coding" class="anchor" href="#stop-coding" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stop Coding</h1>
<blockquote>
<p>Hearken to the reed flute, how it complains, lamenting its banishment from its home: â€œEver since they tore me from my osier bed, my plaintive notes have moved men and women to tears. I burst my breast, striving to give vent to sighs, and to express the pangs of my yearning for my home. He who abides far away from his home is ever longing for the day he shall return.</p>
<p>[The Reed Flute's Song, Rumi, 1207-1273]</p>
</blockquote>
<p>Before diving into code, I <strong>MUST</strong> emphasize that developing custom extensions/addons, while certainly keeewl and exciting, would eventually lead to long-term maintenance/upgrade burdens. Consider direct contributions to the project if/when feasible and solve the problem where it needs solving.</p>
<p>If you are going to write code, you might as well write it where it belongs.</p>
<h1>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requirements</h1>
<p>You will need to have compile-time access to the following modules:</p>
<ul>
<li><code>org.apereo.cas:cas-server-core-webflow</code></li>
<li><code>org.apereo.cas:cas-server-core-web</code></li>
</ul>
<p>These are modules that ship with CAS by default and thou shall mark them with a <code>compile</code> or <code>provided</code> scope in your build configuration.</p>
<h1>
<a id="create-mfa-triggers" class="anchor" href="#create-mfa-triggers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create MFA Triggers</h1>
<p>You should create an event resolver that houses and implements your special requirements for MFA. A typical example might be: <em>Activate MFA provider <code>mfa-duo</code> if the request client IP address matches the pattern <code>123.+</code></em></p>
<pre lang="java"><code>package org.apereo.cas.custom.mfa;

public class CustomWebflowEventResolver extends AbstractCasWebflowEventResolver {

    @Autowired
    private CasConfigurationProperties casProperties;

    @Override
    protected Set&lt;Event&gt; resolveInternal(final RequestContext context) {
        final RegisteredService service = WebUtils.getRegisteredService(context);
        final Authentication authentication = WebUtils.getAuthentication(context);
        final HttpServletRequest request = WebUtils.getHttpServletRequest(context);

        final Map&lt;String, MultifactorAuthenticationProvider&gt; providerMap =
            WebUtils.getAllMultifactorAuthenticationProviders(this.applicationContext);

        // Somehow, select a provider based on the above map...    
        final MultifactorAuthenticationProvider provider = ...

        if (areWeDoingMfa()) {
            final Event event = validateEventIdForMatchingTransitionInContext(provider.getId(), context,
                        buildEventAttributeMap(authentication.getPrincipal(), service, provider)));
            return ImmutableSet.of(event);
        }
        logger.warn("Not doing MFA, sorry.");
        return null;
    }
}
</code></pre>
<p>Note that you have full access to the resolved CAS authentication, the principal associated with it, the service requesting authentication as well as the original web request. You also have access to the full body of CAS configuration settings, should you need to externalize values.</p>
<h1>
<a id="register-mfa-triggers" class="anchor" href="#register-mfa-triggers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Register MFA Triggers</h1>
<p>Your trigger then needs to be registered. We do this via CAS' native auto-configuration strategy, which scans the application context<br>
for relevant annotations inside <code>org.apereo.cas</code> sub-packages. If you change package names, you <strong>MUST</strong> account for the custom context scan too.</p>
<pre lang="java"><code>package org.apereo.cas.custom.config;

@Configuration("SomethingConfiguration")
public class SomethingConfiguration {

    @Autowired
    @Qualifier("initialAuthenticationAttemptWebflowEventResolver")
    private CasDelegatingWebflowEventResolver initialEventResolver;

    @RefreshScope
    @Bean
    public CasWebflowEventResolver customWebflowEventResolver() {
        return new CustomWebflowEventResolver();
    }

    @PostConstruct
    public void initialize() {
        initialEventResolver.addDelegate(customWebflowEventResolver());
    }
}
</code></pre>
<p>We simply register our trigger as a Spring <code>@Bean</code> and add it to the<br>
chain of event resolvers that kick into action as part of CAS authentication machinery.</p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>Note that:</p>
<ul>
<li>You are really not doing anything <em>custom</em>. All CAS triggers behave in the same exact way when<br>
they attempt to resolve the next event.</li>
<li>The API is completely oblivious to multifactor authentication; all it cares about is finding the next event in the chain in a very generic way. Our custom implementation of course makes the next event be concerned about MFA but in theory we could have resolved the next event to be <code>hello-world</code> and CAS would not have cared.</li>
</ul>
<p>Happy Coding!</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>