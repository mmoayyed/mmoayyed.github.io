<hr>
<h2>
<a id="layout-----posttitle------jwt-of-all-things-with-cassummary----a-short-tutorial-on-how-to-let-apereo-cas-handle-authentication-events-accompanied-by-jwtstags-------cas" class="anchor" href="#layout-----posttitle------jwt-of-all-things-with-cassummary----a-short-tutorial-on-how-to-let-apereo-cas-handle-authentication-events-accompanied-by-jwtstags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      JWT Of All Things With CAS<br>
summary:    A short tutorial on how to let Apereo CAS handle authentication events accompanied by JWTs.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<p>Apereo CAS has had built-in support for <a href="https://jwt.io/">JWTs</a> for some time now in a variety of different ways. Notions of JWT support really date back to CAS <code>3.5.x</code> with the work <a href="https://github.com/epierce/cas-server-extension-token">@epierce</a> did as a CAS extension to enable token authentication support. Since then, support for JWTs has significantly improved and grown over the years and continues to get better with an emerging number of use cases whose chief concern is improving performance and removing round-trip calls, among other things.</p>
<p>In this tutorial, I am going to briefly review various forms of JWT functionality in CAS. Specifically, the following topics will be reviewed:</p>
<ul>
<li>
<a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">JWT Authentication</a>: Allowing CAS to accept JWTs as credentials in non-interactive authentication modes mostly.</li>
<li>JWTs with <a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">Duo Security Multifactor Authentication</a>: Exploring an approach where a non-interactive authentication request may be routed to a multifactor authentication flow and back.</li>
<li>
<a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">JWTs as Service Tickets</a>: Allowing CAS to transform service tickets issued for applications into JWTs.</li>
</ul>
<h1>
<a id="environment" class="anchor" href="#environment" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Environment</h1>
<ul>
<li>Apereo CAS <code>5.2.0-SNAPSHOT</code>
</li>
<li>curl <code>7.54.0</code>
</li>
</ul>
<p>...and last but not least, a functional vanilla CAS overlay. For this tutorial, I am using the <a href="https://github.com/apereo/cas-overlay-template">CAS Maven WAR Overlay</a> project.</p>
<h1>
<a id="jwt-authentication" class="anchor" href="#jwt-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JWT Authentication</h1>
<p>CAS provides support for token-based authentication on top of JWTs, where an authentication request can be granted an SSO session based on a form of credentials that are JWTs. CAS expects a <code>token</code> parameter (or request header) to be passed along to the <code>/login</code> endpoint as the credential. The parameter value must of course be a JWT.</p>
<h2>
<a id="let-there-be-jwt" class="anchor" href="#let-there-be-jwt" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let There Be JWT</h2>
<p>To generate a JWT, I ended up using the <a href="https://apereo.github.io/cas/development/installation/Configuring-Commandline-Shell.html">CAS Command-line Shell</a>:</p>
<pre lang="bash"><code>cd cas-overlay-template
./build.sh cli -sh
</code></pre>
<p>This will allow you to enter the interactive shell, where you have documentation, tab-completion and history for all commands.</p>
<pre lang="bash"><code>Welcome to CAS Command-line Shell. For assistance press or type "help" then hit ENTER.
cas&gt;

cas&gt;generate-jwt --subject Misagh

==== Signing Secret ====
MY4Jpxr5VeZsJ...

==== Encryption Secret ====
MZCjxBbDFq9cHPdy...

Generating JWT for subject [Misagh] with signing key size [256], signing algorithm [HS256],
    encryption key size [48], encryption method [A192CBC-HS384] and encryption algorithm [dir]

==== JWT ====
eyJjdHkiOiJKV1QiLCJ...
</code></pre>
<p>Hooray! We have a JWT.</p>
<p>There are a variety of other parameters such as encryption methods and signing algorithms you can choose from to generate the JWT. For the purposes of this tutorial, let's keep things simple. Of course, you don't have to use the CAS command-line shell. Any valid compliant JWT generator would do fine.</p>
<!-- raw HTML omitted -->
<h2>
<a id="configure-application" class="anchor" href="#configure-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure Application</h2>
<p>CAS <a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">needs to be taught</a> the security properties of the JWT to unpack and validate it and produce the relevant authenticated session. For a given authentication request, CAS will try to find the matching record for the application in its registry that is capable of validating JWTs. If such a record is found and the request is in fact accompanied by JWT credentials, the credential is validated and the service ticket issued.</p>
<p>My CAS overlay is already equipped with the <a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">relevant configuration module</a> and my application record using <a href="https://apereo.github.io/cas/development/installation/JSON-Service-Management.html">the JSON service registry</a> looks something like this:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://www.example.org",
  "name" : "Example",
  "id" : 1000,
  "properties" : {
    "@class" : "java.util.HashMap",
    "jwtSigningSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MY4Jpxr5VeZsJ..." ] ]
    },
    "jwtEncryptionSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MZCjxBbDFq9cHPdy..." ] ]
    }
  }
}
</code></pre>
<p>Now, we are ready to start sending requests.</p>
<h2>
<a id="authenticate" class="anchor" href="#authenticate" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authenticate</h2>
<p>Using <code>curl</code> from a terminal, here is the authentication sequence:</p>
<pre lang="bash"><code>$ curl -i "https://mmoayyed.example.net/cas/login?service=https://www.example.org&amp;token=eyJjdHkiOiJKV1QiLCJ..."

HTTP/1.1 302
...
Location: https://www.example.org?ticket=ST-1-zmEt1zfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre>
<p>A few things to note:</p>
<ul>
<li>The <code>-i</code> option allows <code>curl</code> to output the response headers where <code>Location</code> in the above case contains the redirect URL with the issued service ticket.</li>
<li>The entire url in the <code>curl</code> command in encased in double-quotes. This is necessary for <code>curl</code> to ensure the query string is entirely passed along to CAS.</li>
</ul>
<p>Of course, I can pass the JWT as a request header too:</p>
<pre lang="bash"><code>$ curl -i "https://mmoayyed.example.net/cas/login?service=https://www.example.org" --header "token:eyJjdHkiOiJKV1QiLCJ..."

HTTP/1.1 302
...
Location: https://www.example.org?ticket=ST-1-qamgyzfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre>
<p>Grab the <code>ticket</code> from the <code>Location</code> header and proceed to validate it, as you would any regular service ticket.</p>
<h1>
<a id="duo-security-mfa-with-jwts" class="anchor" href="#duo-security-mfa-with-jwts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Duo Security MFA With JWTs</h1>
<p>I want to be able to use my JWT to authenticate with CAS and get a service ticket issued to my application at <code>https://www.example.org</code>, but I also want the request to be verified via second-factor credentials and an MFA flow provided by Duo Security. How do I do that?</p>
<p><a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">Duo Security integration support</a> of CAS is able to also support non-browser based multifactor authentication requests. In order to trigger this behavior, applications (i.e. <code>curl</code>, REST APIs, etc.) need to specify a special <code>Content-Type</code> to signal to CAS that the request is submitted from a non-web based environment. The multifactor authentication request is submitted to Duo Security in <code>auto</code> mode which effectively may translate into an out-of-band factor (push or phone) recommended by Duo as the best for the userâ€™s devices.</p>
<!-- raw HTML omitted -->
<h2>
<a id="configure-duo-security" class="anchor" href="#configure-duo-security" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure Duo Security</h2>
<p>My overlay is prepped with the <a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">relevant configuration module</a> of course and settings that include integration keys, secret keys, etc.</p>
<h2>
<a id="application-mfa-trigger" class="anchor" href="#application-mfa-trigger" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Application MFA Trigger</h2>
<p>I am also going to configure <a href="https://apereo.github.io/cas/development/installation/Configuring-Multifactor-Authentication-Triggers.html#applications">an application-based trigger</a> for <code>https://www.example.org</code> so that authentication requests are routed to the relevant multifactor authentication provider.</p>
<p>So my application record will take on the following form:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://www.example.org",
  "name" : "Example",
  "id" : 1000,
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "multifactorAuthenticationProviders" : [ "java.util.LinkedHashSet", [ "mfa-duo" ] ]
  }
  "properties" : {
    "@class" : "java.util.HashMap",
    "jwtSigningSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MY4Jpxr5VeZsJ..." ] ]
    },
    "jwtEncryptionSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MZCjxBbDFq9cHPdy..." ] ]
    }
  }
}
</code></pre>
<h2>
<a id="authenticate-1" class="anchor" href="#authenticate-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authenticate</h2>
<p>Using <code>curl</code> again from a terminal, here is the authentication sequence:</p>
<pre lang="bash"><code>$ curl -i "https://mmoayyed.example.net/cas/login?service=https://www.example.org"
    --header "token:eyJjdHkiOiJKV1QiLCJ..." --header "Content-Type: application/cas"

HTTP/1.1 302
...
Location: https://www.example.org?ticket=ST-1-gdfe1zfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre>
<p>Things work exactly the same as before, except that this time your device registered with Duo Security will receive a  notification where your approval will authorize CAS to establish a session and generate a ticket.</p>
<h1>
<a id="jwt-service-tickets" class="anchor" href="#jwt-service-tickets" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>JWT Service Tickets</h1>
<p>All operations so far have issued a regular service ticket back to the application that must be validated in a subsequent trip so the application can retrieve the authenticated user profile. In a different variation, it's possible for the service ticket itself to <a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">take on the form of a JWT</a>. JWT-based service tickets are issued to applications based on the same semantics defined by the CAS Protocol. CAS having received an authentication request via its <code>/login</code> endpoint will conditionally issue back JWT service tickets to the application in form of a <code>ticket</code> parameter via the requested http method.</p>
<!-- raw HTML omitted -->
<h2>
<a id="configure-jwts" class="anchor" href="#configure-jwts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure JWTs</h2>
<p>In order for CAS to transform service tickets into JWTs, essentially we need to execute the reverse of the above configuration steps. We will need to ensure CAS is provided with relevant keys to generate JWTs and these keys are in turn used by the application to unpack the <em>JWTness</em> of generated service ticket.</p>
<p>The overlay also needs to be equipped with <a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">the relevant extension module</a> of course to allow for this functionality.</p>
<p>You may generate the required secrets manually per the above link. In this example, I left them undefined in my properties which forces CAS to generate a few on its own and warn me about them when it starts up:</p>
<pre lang="bash"><code>... - &lt;Secret key for encryption is not defined for [Token/JWT Tickets]; 
    CAS will attempt to auto-generate the encryption key&gt;
... - &lt;Generated encryption key [...] of size [256] for [Token/JWT Tickets]. 
    The generated key MUST be added to CAS settings under setting [cas.authn.token.crypto.encryption.key].&gt;
... - &lt;Secret key for signing is not defined for [Token/JWT Tickets]. 
    CAS will attempt to auto-generate the signing key&gt;
... - &lt;Generated signing key [...] of size [512] for [Token/JWT Tickets]. 
    The generated key MUST be added to CAS settings under setting [cas.authn.token.crypto.signing.key].&gt;
</code></pre>
<p>Fine! Let's proceed.</p>
<h2>
<a id="configure-application-1" class="anchor" href="#configure-application-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure Application</h2>
<p>JWTs as service tickets are issued on a per-application basis. This means that once CAS finds a matching record for the application in its registry, it will try to determine if the application requires JWTs as service tickets. So my application record will take on the following form:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://www.example.org",
  "name" : "Example",
  "id" : 1000,
  "multifactorPolicy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy",
    "multifactorAuthenticationProviders" : [ "java.util.LinkedHashSet", [ "mfa-duo" ] ]
  }
  "properties" : {
    "@class" : "java.util.HashMap",
    "jwtSigningSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MY4Jpxr5VeZsJ..." ] ]
    },
    "jwtEncryptionSecret" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "MZCjxBbDFq9cHPdy..." ] ]
    },
    "jwtAsResponse" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceProperty",
      "values" : [ "java.util.HashSet", [ "true" ] ]
    }
  }
}
</code></pre>
<p>Now, we are ready to start sending requests.</p>
<h2>
<a id="authenticate-2" class="anchor" href="#authenticate-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authenticate</h2>
<p>Using <code>curl</code> again from a terminal, here is the authentication sequence:</p>
<pre lang="bash"><code>$ curl -i "https://mmoayyed.example.net/cas/login?service=https://www.example.org" 
    --header "token:eyJjdHkiOiJKV1QiLCJ..." --header "Content-Type: application/cas"

HTTP/1.1 302
...
Location: https://www.example.org?ticket=eyJhbGciOiJIUzUxMiJ9.WlhsS05tRllRV2xQYVVwRlVsV...
...
</code></pre>
<p>This works exactly the same as before, except that now the <code>ticket</code> parameter contains a JWT as a service ticket.</p>
<h1>
<a id="summary" class="anchor" href="#summary" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Summary</h1>
<p>I hope this tutorial was of some help to you. As you have been reading, I can guess that you have come up with a number of missing bits and pieces that would satisfy your JWT needs more comprehensively with CAS. In a way, that is exactly what this tutorial intends to inspire. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>