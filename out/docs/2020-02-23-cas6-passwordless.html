<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---advanced-passwordless-authenticationsummary----playing-around-with-different-variations-of-passwordless-authentication-in-cas-integrating-it-with-other-advanced-authentication-flows-such-as-delegated-authentication-multifactor-and-morepublished-truetags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---advanced-passwordless-authenticationsummary----playing-around-with-different-variations-of-passwordless-authentication-in-cas-integrating-it-with-other-advanced-authentication-flows-such-as-delegated-authentication-multifactor-and-morepublished-truetags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Advanced Passwordless Authentication<br>
summary:    Playing around with different variations of Passwordless Authentication in CAS, integrating it with other advanced authentication flows such as delegated authentication, multifactor and more.<br>
published: true<br>
tags:       [CAS]</h2>
<p>Since the introduction of <a href="https://fawnoos.com/2019/07/18/cas61x-passwordless-authn/">Passwordless Authentication</a> in CAS <code>6.1.x</code>, a lot of additional and useful improvements are added to make this integration seamlessly integrate with other forms of authentication such as delegation or multifactor. This blog post intends to demonstrate a few advanced variations of passwordless authentication in combination with other authentication flows and forms.</p>
<p>Our starting position is based on the following:</p>
<ul>
<li>CAS <code>6.2.x</code>
</li>
<li>Java 11</li>
</ul>
<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h2>
<p>Passwordless Authentication in CAS by default is a form of authentication where passwords are replaced by tokens that expire after a configurable time period. Users are asked for an identifier (i.e. username) which is then used to locate the user record that contains forms of contact such as email and phone number to receive the token. While this works nicely for certain use cases, there are now other variations available where the <em>passwordless</em> user account fetched relevant user repositories can skip the default flow in favor of multifactor or delegated authentication. Furthermore, it is now also possible to, <em>conditionally</em>, skip the default passwordless authentication flow and simply challenge the user for their password as one might traditionally expect.</p>
<p>Passwordless Authn might also be interpreted as <a href="https://webauthn.io/">WebAuthn support</a>; a specification and API written by the W3C and FIDO that allows identity providers such as CAS to register and authenticate users using public-key cryptography instead of a password. While this behavior can be achieved using certain multifactor provider integrations with CAS that provide WebAuthn support, built-in native support for WebAuthn is <em>not available</em> as of this writing and may become available in future releases.</p>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>Once you have decorated the CAS WAR Overlay with the proper <a href="https://apereo.github.io/cas/development/installation/Passwordless-Authentication.html">extension module</a>, you will need to adjust your CAS configuration (i.e. <code>cas.properties</code> file) to tune the feature for the following:</p>
<h2>
<a id="user-accounts" class="anchor" href="#user-accounts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>User Accounts</h2>
<p>How should user records and contact information be found, given an identifier?</p>
<p>To keep things simple for this tutorial, we are going to use a Groovy script to locate our passwordless accounts:</p>
<pre lang="properties"><code>cas.authn.passwordless.accounts.groovy.location=file:/etc/cas/config/PasswordlessAccounts.groovy
</code></pre>
<p>...and the Groovy script may be designed as:</p>
<pre lang="groovy"><code>def run(Object[] args) {
    def username = args[0]
    def logger = args[1]
    
    logger.info("Locating user record for user $username")

    /*
     * Query relevant data sources to fetch
     * the passwordless account record...
     */

    def account = new PasswordlessUserAccount()
    account.setUsername("casuser")
  
    /*
     * Modify the account as appropriate...
     */

    return account
}
</code></pre>
<h2>
<a id="skip-passwordless-authentication" class="anchor" href="#skip-passwordless-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Skip Passwordless Authentication</h2>
<p>A passwordless account can be optionally tagged to use the traditional authentication flow that typically challenges the user for their password. To do this, the account needs to be modified as such:</p>
<pre lang="groovy"><code>  ...
  account.setRequestPassword(true)
  ...
</code></pre>
<p>In doing so, CAS will skip the default passwordless authentication flow in favor of its default primary authentication strategy where you might see this:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/74814088-ffd53880-530f-11ea-860a-392f33ce3b03.png" alt="image"></p>
<h2>
<a id="delegated-authentication" class="anchor" href="#delegated-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Delegated Authentication</h2>
<p>In another variation, the passwordless account can skip its default flow in favor of delegated authentication. To do so and with the assumption that <a href="https://apereo.github.io/cas/development/integration/Delegate-Authentication.html">delegated authentication</a> is turned on in CAS, we can tag the account as one who's eligible for delegated authentication via:</p>
<pre lang="groovy"><code>  ...
  account.setDelegatedAuthenticationEligible(true)  
  ...
</code></pre>
<p>This requires a separate decision to select the identity provider from the list of those that are available and configured in CAS. To do this, we can design a small Groovy script tasked to decide and select the appropriate identity provider for our passwordless user:</p>
<pre lang="properties"><code>cas.authn.passwordless.delegatedAuthenticationSelectorScript.location= \
    file:/etc/cas/config/PasswordlessDelegated.groovy
</code></pre>
<p>...and the selection script would be:</p>
<pre lang="groovy"><code>def run(Object[] args) {
  def user = args[0]
  def clients = (Set) args[1]
  def httpServletRequest = args[2]
  def logger = args[3]

  logger.info("Choose identity provider for $user")

  /*
   * Pick an identity provider from 
   * the list of clients available
   */
  return clients[0]
}
</code></pre>
<h2>
<a id="multifactor-authentication" class="anchor" href="#multifactor-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multifactor Authentication</h2>
<p>In another variation, the passwordless account can skip its default flow in favor of <a href="https://apereo.github.io/cas/development/mfa/Configuring-Multifactor-Authentication.html">multifactor authentication</a> using a multifactor provider that is found configured and available in CAS. In doing so and much like other variations, the account must be tagged as one eligible for multifactor authentication:</p>
<pre lang="groovy"><code>  ...
  account.setMultifactorAuthenticationEligible(true)
  ...
</code></pre>
<p>Once the account is deemed eligible for a multifactor authentication flow, it is processed by the collection of multifactor authentication triggers to select the appropriate provider. To keep things simple, let's say we would want to require MFA for users with an attribute <code>category</code> whose value(s) matches a pattern of <code>student</code> or <code>admin</code>.</p>
<pre lang="properties"><code>cas.authn.mfa.globalPrincipalAttributeNameTriggers=category
cas.authn.mfa.globalPrincipalAttributeValueRegex=student|admin
</code></pre>
<p>Let's also make sure our demo passwordless account carries that relevant attribute:</p>
<pre lang="groovy"><code>  ...
  def attributes = Map.of("category", List.of("student", "admin")) 
  account.setAttributes(attributes) 
  ...
</code></pre>
<p>With the above configuration, the account is processed by CAS <a href="https://apereo.github.io/cas/development/mfa/Configuring-Multifactor-Authentication-Triggers.html">multifactor authentication triggers</a> to route to the appropriate multifactor authentication flow.</p>
<h2>
<a id="finale" class="anchor" href="#finale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finale</h2>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>