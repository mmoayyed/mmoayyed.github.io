<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---integration-with-hashicorp-vaultsummary----cas-distributed-configuration-management-using-hashcorp-vault-where-you-learn-how-to-store-and-secure-cas-configuration-settings-and-properties-inside-vaulttags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---integration-with-hashicorp-vaultsummary----cas-distributed-configuration-management-using-hashcorp-vault-where-you-learn-how-to-store-and-secure-cas-configuration-settings-and-properties-inside-vaulttags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Integration with HashiCorp Vault<br>
summary:    CAS distributed configuration management using HashCorp Vault, where you learn how to store and secure CAS configuration settings and properties inside Vault.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<p><a href="https://www.vaultproject.io/">Vault</a> is a tool for securely accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, certificates, and more. Vault provides a unified interface to any secret while providing tight access control and recording a detailed audit log.</p>
<p>The CAS integration with vault <a href="https://apereo.github.io/cas/development/configuration/Configuration-Properties-Security.html#vault">has been available</a> for some time. In this walkthrough, we are going to take a pass at getting CAS connected to Vault to store properties and settings. We will also try to reload settings dynamically in real-time as they are changed and updated inside Vault.</p>
<!-- raw HTML omitted -->
<p>Our starting position is based on the following:</p>
<ul>
<li>CAS <code>6.0.0-RC4</code>
</li>
<li>Java 11</li>
<li>
<a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a> (The <code>master</code> branch specifically)</li>
<li><a href="https://www.docker.com/get-started">Docker</a></li>
<li><a href="https://stedolan.github.io/jq/">CLI JSON Processor <code>jq</code></a></li>
</ul>
<h2>
<a id="vault" class="anchor" href="#vault" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Vault</h2>
<p>To run Vault for development and testing, we can use the provided Docker image:</p>
<pre lang="bash"><code>docker run --cap-add=IPC_LOCK -d -e 'VAULT_DEV_ROOT_TOKEN_ID=CAS' -p 8200:8200 --name=vault vault
docker ps
</code></pre>
<p>This runs a completely in-memory Vault server, which is useful for development but <strong>SHOULD NOT</strong> be used in production. Note the environment variable <code>VAULT_DEV_ROOT_TOKEN_ID</code> which sets the ID of the initially generated root token to the given value. We will use this token, later on, to log into the Vault UI and it will be also be utilized when CAS attempts to connect to Vault.</p>
<p>To access the Vault UI, point your browser to <code>http://localhost:8200/ui</code> and use the above token to log into Vault where you'd be greeted with the following screen:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/47616833-06b2b900-dad7-11e8-99bc-5c44c0d900d2.png" alt="image"></p>
<p>So, let's create a few secrets. Secrets inside Vault can be managed inside folders where from the CAS perspective, the folder hierarchy is expected to match the following:</p>
<pre><code>/secret/{application}/{profile}
/secret/{application}
</code></pre>
<p>...where <code>application</code> is the value of <code>spring.application.name</code> which is by default <code>cas</code> and the <code>profile</code> is any a tag/label assigned to a collection of settings that would be activated and fetched if the CAS server is deployed using said profile(s). So, as an example, we can create a secret for <code>cas.authn.accept.users</code> with the value of <code>casuser::Vault</code>. We will put this secret inside the path <code>/secret/cas/vault</code> where <code>cas</code> is the name of our application and <code>vault</code> is the profile name we shall activate when running CAS.</p>
<p><img src="https://user-images.githubusercontent.com/1205228/47643977-35399e00-db82-11e8-9ca3-4202c3125476.png" alt="image"></p>
<p>Note that I have added a number of other settings to allow access to the CAS actuator endpoints. This will allow us to refresh the state of CAS application context, once a setting is updated with a new value.</p>
<!-- raw HTML omitted -->
<p>That should do for now. Let's get CAS running.</p>
<h2>
<a id="cas" class="anchor" href="#cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CAS</h2>
<p>Integration with Vault in CAS is handled using <a href="https://cloud.spring.io/spring-cloud-vault/">Spring Cloud Vault</a> and can be done in a number of ways:</p>
<ul>
<li>
<p>If you have the <a href="https://fawnoos.com/2018/10/25/cas6-cloud-config-server/">Spring Cloud Config Server</a> deployed, Vault could be one of its many sources for settings and properties. In this scenario, you will just need to make sure the CAS server can talk to the Spring Cloud Config Server correctly, and the Config Server is then in charge of communicating with Vault to fetch settings, etc.</p>
</li>
<li>
<p>Alternatively, you may decide to connect your CAS server directly to Vault and fetch settings. This is the approach we are going to try in this tutorial for a quick win, but do note that the strategy is almost the same if we were to use the Cloud Config server.</p>
</li>
</ul>
<p>So in order to enable a CAS integration with Vault <em>directly</em>, you want to start with the <a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a>, clone the project and then put the following settings into a <code>src/main/resources/bootstrap.properties</code> file:</p>
<pre lang="properties"><code>spring.application.name=cas
spring.profiles.active=vault

spring.cloud.vault.host=localhost
spring.cloud.vault.port=8200
spring.cloud.vault.token=CAS
spring.cloud.vault.enabled=true
spring.cloud.vault.reactive.enabled=false
spring.cloud.vault.fail-fast=true
spring.cloud.vault.scheme=http

spring.cloud.vault.kv.enabled=true
spring.cloud.vault.kv.backend=secret
</code></pre>
<p>We are teaching CAS to find our Vault server at <code>http://localhost:8200</code> and use the generated token <code>CAS</code> for authenticated requests.</p>
<!-- raw HTML omitted -->
<p>We have also enabled the versioned Key-Value secret backend. The key-value backend allows storage of arbitrary values as key-value store. A single context can store one or many key-value tuples. Contexts can be organized hierarchically. Per our previous work in Vault, the backend is called <code>secret</code>.</p>
<p>Note that there are many other types of backends supported. See <a href="https://cloud.spring.io/spring-cloud-vault/">Spring Cloud Vault</a> for more info.</p>
<p>Of course, don't forget to include the required module in your CAS build:</p>
<pre lang="gradle"><code>compile "org.apereo.cas:cas-server-support-configuration-cloud-vault:${project.'cas.version'}"
</code></pre>
<p>Build and deploy. At this point, you should be able to log into CAS using <code>casuser</code> and <code>Vault</code> as the credentials!</p>
<h3>
<a id="refresh--reload" class="anchor" href="#refresh--reload" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Refresh &amp; Reload</h3>
<p>If a secret changes, Vault has no way to broadcast the updated value(s) to its own clients, such as the CAS server itself. Therefore, in order to broadcast such change events CAS presents various endpoints that allow the user to <a href="https://apereo.github.io/cas/development/configuration/Configuration-Management-Reload.html">refresh the configuration</a> as needed. This means that an adopter would simply change a required CAS setting and then would submit a request to CAS to <em>refresh</em> its current state. At runtime! All CAS internal components that are affected by the external change are quietly reloaded and the setting takes immediate effect, completely removing the need for container restarts or CAS re-deployments.</p>
<p>For example, start by changing the value of <code>cas.authn.accept.users</code> in Vault to something like <code>casuser::HelloWorld</code>. Then, execute the following command to refresh the CAS application context:</p>
<pre lang="bash"><code>curl -k -u casuser:Mellon https://sso.example.org/cas/actuator/refresh -d {} -H "Content-Type: application/json"

...
["cas.authn.accept.users"]
</code></pre>
<p>At this point, you should be able to log into CAS using <code>casuser</code> and <code>HelloWorld</code> as the credentials!</p>
<h2>
<a id="finale" class="anchor" href="#finale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finale</h2>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>