<hr>
<h2>
<a id="layout-----posttitle------cas-5-database-authentication-tutorialsummary----learn-how-to-configure-database-authentication-in-cas-5tags-------cas" class="anchor" href="#layout-----posttitle------cas-5-database-authentication-tutorialsummary----learn-how-to-configure-database-authentication-in-cas-5tags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      CAS 5 Database Authentication Tutorial<br>
summary:    Learn how to configure database authentication in CAS 5.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<p>This is a short and sweet tutorial on how to configure CAS to authenticate against a database and then resolve/release attributes.<br>
Most of the material is based on the <a href="https://apereo.github.io/cas/development/installation/Database-Authentication.html">available documentation</a>.</p>
<p>This tutorial specifically focuses on:</p>
<ul>
<li>CAS <code>5.1.0-RC2-SNAPSHOT</code>
</li>
<li>HSQLDB <code>2.3.4</code>
</li>
<li>Java 8</li>
<li>Apache Tomcat <code>8.5.11</code>
</li>
</ul>
<h1>
<a id="database" class="anchor" href="#database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Database</h1>
<p>To keep things rather simple, we'll be installing an instance of <a href="http://hsqldb.org/">HSQLDB</a>. For this exercise, I am running <code>2.3.4</code>, though note that the recipe is for the most part the same when dealing with other database instances as well, whether installed manually or run in a dockerized fashion.</p>
<p>So running HSQL shows me:</p>
<pre lang="bash"><code>[Server@2ff4acd0]: [Thread[main,5,main]]: checkRunning(false) entered
[Server@2ff4acd0]: [Thread[main,5,main]]: checkRunning(false) exited
[Server@2ff4acd0]: Startup sequence initiated from main() method
[Server@2ff4acd0]: Could not load properties from file
[Server@2ff4acd0]: Using cli/default properties only
[Server@2ff4acd0]: Initiating startup sequence...
[Server@2ff4acd0]: Server socket opened successfully in 46 ms.
[Server@2ff4acd0]: Database [index=0, id=0, db=file:mydb, alias=xdb] opened successfully in 349 ms.
[Server@2ff4acd0]: Startup sequence completed in 396 ms.
[Server@2ff4acd0]: 2017-02-21 13:44:37.717 HSQLDB server 2.3.4 is online on port 9001
[Server@2ff4acd0]: To close normally, connect and execute SHUTDOWN SQL
[Server@2ff4acd0]: From command line, use [Ctrl]+[C] to abort abruptly
</code></pre>
<p>Great. Moving on...</p>
<h1>
<a id="create-schema" class="anchor" href="#create-schema" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create Schema</h1>
<p>In my setup, I have two tables: one called <code>USERS</code> where user accounts are kept and another called <code>USERATTRS</code> where user attributes are kept. My <code>USERS</code> table is rather simple, but the <code>USERATTRS</code> follows something of a <em>multi-row</em> setup. You want to learn more about this setup <a href="https://apereo.github.io/cas/development/integration/Attribute-Resolution.html#person-directory">here</a>.</p>
<p>So here goes the SQL:</p>
<pre lang="sql"><code>DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS USERATTRS;

CREATE TABLE USERATTRS (
  id INT NOT NULL IDENTITY ,
  uid VARCHAR(50) NOT NULL,
  attrname VARCHAR(50) NOT NULL,
  attrvalue VARCHAR(50) NOT NULL
);


CREATE TABLE USERS (
  id INT NOT NULL IDENTITY ,
  uid VARCHAR(50) NOT NULL,
  psw VARCHAR(50) NOT NULL
);

INSERT INTO USERS (uid, psw)
VALUES ('mmoayyed', 'TheBestPasswordEver');

INSERT INTO USERATTRS (uid,  attrname, attrvalue)
VALUES ('mmoayyed', 'firstname', 'Misagh');

INSERT INTO USERATTRS (uid, attrname, attrvalue)
VALUES ('mmoayyed', 'lastname', 'Moayyed');

INSERT INTO USERATTRS (uid, attrname, attrvalue)
VALUES ('mmoayyed', 'phone', '+13476452319');
</code></pre>
<p>Note that for the time being, I am just keeping the password as plain-text in the table. No encoding or anything has taken place.</p>
<h1>
<a id="deploy-cas" class="anchor" href="#deploy-cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deploy CAS</h1>
<p>Hop over to <a href="https://apereo.github.io/cas/development/installation/Maven-Overlay-Installation.html">the overlay installation</a> and get CAS built and deployed. The CAS version I am using today is <code>5.1.0-RC2-SNAPSHOT</code>. It does not matter whether you end up using Maven or Gradle. Choose what fits you best. When you have a baseline functioning build, continue on.</p>
<h1>
<a id="configure-cas" class="anchor" href="#configure-cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure CAS</h1>
<p>Follow the steps <a href="https://apereo.github.io/cas/development/installation/Database-Authentication.html">described here</a> to add the needed CAS modules. Once the module/dependency is added to your build, hop over to <a href="https://apereo.github.io/cas/development/installation/Configuration-Properties.html#database-authentication">the settings page</a> and add the properties.</p>
<p><em>Note that I did not have to add any additional JARs and such for database drivers. CAS ships with a few <a href="https://apereo.github.io/cas/development/installation/JDBC-Drivers.html">automatically and by default</a></em></p>
<p>For this tutorial, this is what I actually needed to make this work:</p>
<pre lang="properties"><code>cas.authn.jdbc.query[0].sql=SELECT * FROM USERS WHERE uid=?
cas.authn.jdbc.query[0].url=jdbc:hsqldb:hsql://localhost:9001/xdb
cas.authn.jdbc.query[0].dialect=org.hibernate.dialect.HSQLDialect
cas.authn.jdbc.query[0].user=sa
cas.authn.jdbc.query[0].password=
cas.authn.jdbc.query[0].driverClass=org.hsqldb.jdbcDriver
cas.authn.jdbc.query[0].fieldPassword=psw
</code></pre>
<p>I also need to disable static authentication. It would also be very nice if I could turn on <code>DEBUG</code> logs and see what CAS attempts to do:</p>
<pre lang="properties"><code>logging.level.org.apereo=DEBUG
cas.authn.accept.users=
</code></pre>
<h1>
<a id="build-and-deploy" class="anchor" href="#build-and-deploy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build and Deploy</h1>
<p>Once you get CAS built and deployed, logs should indicate something like this:</p>
<pre lang="bash"><code>2017-02-21 14:20:18,267 DEBUG [org.apereo.cas.configuration.support.Beans] - &lt;No password encoder shall be created given the requested encoder type [NONE]&gt;
2017-02-21 14:20:18,277 DEBUG [org.apereo.cas.adaptors.jdbc.config.CasJdbcAuthenticationConfiguration] - &lt;Created authentication handler [QueryDatabaseAuthenticationHandler] to handle database url at [jdbc:hsqldb:hsql://localhost:9001/xdb]&gt;
</code></pre>
<p>Log in with <code>mmoayyed</code> and <code>TheBestPasswordEver</code> and you should be in. Viola!</p>
<h1>
<a id="password-encoding" class="anchor" href="#password-encoding" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Password Encoding</h1>
<p>As an extra bonus exercise, let's turn on <code>MD5</code> password encoding. The MD5 hash of <code>TheBestPasswordEver</code> is <code>ca541f57a3041c3b85c553d12d3e64a8</code>.</p>
<p>So we will update the database accordingly.</p>
<pre lang="sql"><code>UPDATE USERS SET psw='ca541f57a3041c3b85c553d12d3e64a8' WHERE uid='mmoayyed';
</code></pre>
<p>Then configure CAS to handle <code>MD5</code> password encoding:</p>
<pre lang="properties"><code>cas.authn.jdbc.query[0].passwordEncoder.type=DEFAULT
cas.authn.jdbc.query[0].passwordEncoder.encodingAlgorithm=MD5
cas.authn.jdbc.query[0].passwordEncoder.characterEncoding=UTF-8
</code></pre>
<h1>
<a id="build-and-deploy-1" class="anchor" href="#build-and-deploy-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build and Deploy</h1>
<p>Once you get CAS built and deployed, logs should indicate something like this:</p>
<pre lang="bash"><code>2017-02-21 14:44:31,884 DEBUG [org.apereo.cas.configuration.support.Beans] - &lt;Creating default password encoder with encoding alg [MD5] and character encoding [UTF-8]&gt;
</code></pre>
<p>Build and deploy. Log in with <code>mmoayyed</code> and <code>TheBestPasswordEver</code> and you should be in. Logs may indicate:</p>
<pre lang="bash"><code>2017-02-21 14:45:55,517 DEBUG [org.apereo.cas.util.crypto.DefaultPasswordEncoder] - &lt;Encoded password via algorithm [MD5] and character-encoding [UTF-8] is [ca541f57a3041c3b85c553d12d3e64a8]&gt;
2017-02-21 14:45:55,517 DEBUG [org.apereo.cas.util.crypto.DefaultPasswordEncoder] - &lt;Provided password does match the encoded password&gt;
2017-02-21 14:45:55,519 DEBUG [org.apereo.cas.authentication.AbstractAuthenticationManager] - &lt;Authentication handler [QueryDatabaseAuthenticationHandler] successfully authenticated [mmoayyed]&gt;
</code></pre>
<p>Good job! Lets get some attributes now.</p>
<h1>
<a id="attributes" class="anchor" href="#attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Attributes</h1>
<p>Because the <code>USERATTRS</code> follows something of a <em>multi-row</em> setup, we want to make sure CAS <a href="https://apereo.github.io/cas/development/integration/Attribute-Resolution.html#person-directory">can understand</a> the specifics of this schema model. Today, CAS is unable to retrieve attributes as part of authentication directly so we need to set up a separate attribute repository instance that CAS will contact once the user is fully authenticated. In our case, the attribute repository is the same database instance. So the configuration may look something like this:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.jdbc[0].singleRow=false
cas.authn.attributeRepository.jdbc[0].sql=SELECT * FROM USERATTRS WHERE {0}
cas.authn.attributeRepository.jdbc[0].username=uid
cas.authn.attributeRepository.jdbc[0].url=jdbc:hsqldb:hsql://localhost:9001/xdb
cas.authn.attributeRepository.jdbc[0].columnMappings.attrname=attrvalue
</code></pre>
<p>Once CAS understands the schema, we should then specify which attributes really should be retrieved by CAS.</p>
<pre lang="properties"><code>cas.authn.attributeRepository.attributes.firstname=firstname
cas.authn.attributeRepository.attributes.lastname=lastname
# cas.authn.attributeRepository.attributes.phone=phone
</code></pre>
<p>Note how I am skipping over <code>phone</code>.</p>
<p>The above says, <em>Retrieve attributes <code>firstname</code> and <code>lastname</code> from the repositories and keep them as they are</em>.<br>
If we wanted to, we could virtually rename the attributes to for instance <code>TheFir$tN@me</code> and <code>simpleL@stnam3</code>.</p>
<h1>
<a id="release-attributes" class="anchor" href="#release-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Release Attributes</h1>
<p>There are multiple ways of <a href="https://apereo.github.io/cas/development/integration/Attribute-Release.html">releasing attributes</a>. For this tutorial, I am going to release them globally to all applications:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.defaultAttributesToRelease=firstname,lastname
</code></pre>
<p>Note how I am skipping over <code>phone</code>.</p>
<h1>
<a id="build-and-deploy-2" class="anchor" href="#build-and-deploy-2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build and Deploy</h1>
<p>For this to actually be tested, we need a client to which we can release attributes, right? You can use whatever client/application you like, as long as it's able to retrieve attributes. I ended up using <a href="https://github.com/cas-projects/cas-sample-java-webapp">this</a>. When attempting to access the application, I get redirected to CAS. Once I log in and return, I see the following in the CAS logs on startup:</p>
<pre lang="bash"><code>2017-02-21 14:54:04,885 DEBUG [org.apereo.cas.config.CasPersonDirectoryConfiguration] - &lt;Configured multi-row JDBC attribute repository for [jdbc:hsqldb:hsql://localhost:9001/xdb]&gt;
2017-02-21 14:54:04,889 DEBUG [org.apereo.cas.config.CasPersonDirectoryConfiguration] - &lt;Configured multi-row JDBC column mappings for [jdbc:hsqldb:hsql://localhost:9001/xdb] are [{attrname=attrvalue}]&gt;
2017-02-21 14:54:04,890 DEBUG [org.apereo.cas.config.CasPersonDirectoryConfiguration] - &lt;Configured result attribute mapping for [jdbc:hsqldb:hsql://localhost:9001/xdb] to be [{firstname=firstname, lastname=lastname}]&gt;
</code></pre>
<p>Which shows that CAS has been able to understand the schema and map columns to attributes. Logging into the client application also shows me:</p>
<p><img src="https://cloud.githubusercontent.com/assets/1205228/23163353/5c39f42a-f847-11e6-806e-6d4e3ca88805.png" alt="image"></p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this brief tutorial was of some assistance to you. Remember that the point here is not to enumerate best practices and such. It's just to show the possibilities. It's important that you start off simple and make changes one step at a time. Once you have a functional environment, you can gradually and slowly add customizations to move files, tables and queries around.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>