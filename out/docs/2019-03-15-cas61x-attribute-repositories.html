<hr>
<h2>
<a id="layout-----posttitle------apereo-cas-61x---attribute-repositories-w-person-directorysummary----an-overview-of-cas-attribute-repositories-and-strategies-on-how-to-fetch-attributes-from-a-variety-of-sources-in-addition-to-the-authentication-source-merge-and-combine-attributes-from-said-sources-to-ultimately-release-them-to-applications-with-a-fair-bit-of-cachingtags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas-61x---attribute-repositories-w-person-directorysummary----an-overview-of-cas-attribute-repositories-and-strategies-on-how-to-fetch-attributes-from-a-variety-of-sources-in-addition-to-the-authentication-source-merge-and-combine-attributes-from-said-sources-to-ultimately-release-them-to-applications-with-a-fair-bit-of-cachingtags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS 6.1.x - Attribute Repositories w/ Person Directory<br>
summary:    An overview of CAS attribute repositories and strategies on how to fetch attributes from a variety of sources in addition to the authentication source, merge and combine attributes from said sources to ultimately release them to applications with a fair bit of caching.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>The ability to fetch attributes from external data stores has been present in CAS since the days of <code>3.x</code>. This functionality was and, to this day, is provided by an Apereo project called <a href="https://github.com/apereo/person-directory">Person Directory</a> which is a Java framework for resolving persons and attributes from a variety of underlying sources. It consists of a collection of components that retrieve, cache, resolve, aggregate and merge person attributes from JDBC, LDAP and more. CAS attempts to take advantage of this framework through a concept called <code>PrincipalResolver</code> whose goal is to construct a final identifiable authenticated principal for CAS which carries a number of attributes inside it fetched from attribute repository sources. This meant that for instance, one could authenticate with LDAP in one query and then turn around the ask the same LDAP, a relational database and a Groovy script to fetch attributes for the resolved principal and combine all results into a final collection.</p>
<p>Note that in most cases, and starting around CAS <code>4.x</code>, the authentication engine has been enhanced to be able to retrieve and resolve attributes from the authentication source, which would eliminate the need for configuring a separate attribute repository especially if both the authentication and the attribute source are the same. Using separate resolvers and sources should only be required when sources are different, or when there is a need to tackle more advanced attribute resolution use cases such as cascading, merging, etc.</p>
<!-- raw HTML omitted -->
<p>This tutorial focuses on a number of use case involving attribute repositories, fetching attributes from an external store a JSON file and a collection of hard-coded stubbed attributes. We will demonstrate variations on how attribute sources may be cached, filtered and released in a number of fancy ways.</p>
<p>Our starting position is based on:</p>
<ul>
<li>CAS <code>6.1.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
<li><a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON Service Registry</a></li>
<li>Using CAS default credentials, <code>casuser</code> and <code>Mellon</code> via static authentication.</li>
</ul>
<h2>
<a id="baseline-configuration" class="anchor" href="#baseline-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Baseline Configuration</h2>
<p>Our JSON attribute repository source, separate from the CAS authentication store is fairly simple:</p>
<pre lang="json"><code>{
    "casuser": {
        "firstName": ["Bob"],
        "employeeNumber": ["123456"],
        "lastName": ["Johnson"]
    }
}
</code></pre>
<p>Our external attribute repositories are then taught to CAS:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.json[0].location=file://etc/cas/config/attribute-repository.json
cas.authn.attributeRepository.json[0].id=MyJson

cas.authn.attributeRepository.stub.id=StaticStub
cas.authn.attributeRepository.stub.attributes.uid=mmoayyed
cas.authn.attributeRepository.stub.attributes.displayName=Misagh Moayyed
cas.authn.attributeRepository.stub.attributes.firstName=Misagh
cas.authn.attributeRepository.stub.attributes.lastName=Moayyed
</code></pre>
<p>Note that each attribute repository is given an <code>id</code> which can the be used as a filter to narrow the resolution logic down to matching repositories.</p>
<h2>
<a id="use-cases" class="anchor" href="#use-cases" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Use Cases</h2>
<h3>
<a id="1" class="anchor" href="#1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1</h3>
<p>The requirements for this use case are as follows:</p>
<ul>
<li>Disable attribute resolution from external attribute repositories via Person Directory.</li>
<li>Resolve attributes at release time for a given application only using the <code>MyJson</code> attribute repository.</li>
<li>No caching of attributes shall happen either globally or for the application.</li>
</ul>
<p>The relevant properties for this use case are:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.expirationTime=0
cas.authn.attributeRepository.expirationTimeUnit=seconds
cas.authn.attributeRepository.merger=multivalued

cas.personDirectory.attributeResolutionEnabled=false
</code></pre>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.DefaultPrincipalAttributesRepository",
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]]
    }
  }
}
</code></pre>
<p>Since caching is disabled, you can change the underlying attribute value in the JSON attribute repository<br>
and CAS should pick up the change and release the new attribute value to the example application.</p>
<h2>
<a id="2" class="anchor" href="#2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2</h2>
<p>The requirements for this use case are as follows:</p>
<ul>
<li>Disable attribute resolution from external attribute repositories via Person Directory.</li>
<li>Resolve attributes at release time for a given application only using the <code>MyJson</code> attribute repository.</li>
<li>Turn on global caching of attributes for <code>60</code> seconds.</li>
</ul>
<p>The relevant properties for this use case are:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.expirationTime=60
cas.authn.attributeRepository.expirationTimeUnit=seconds
cas.authn.attributeRepository.merger=multivalued

cas.personDirectory.attributeResolutionEnabled=false
</code></pre>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.DefaultPrincipalAttributesRepository",
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]]
    }
  }
}
</code></pre>
<p>Since caching is disabled, you can change the underlying attribute value in the JSON attribute repository<br>
and CAS should pick up the change and release the new attribute value to the example application in about <code>60</code> seconds.</p>
<h2>
<a id="3" class="anchor" href="#3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3</h2>
<p>The requirements for this use case are as follows:</p>
<ul>
<li>Disable attribute resolution from external attribute repositories via Person Directory.</li>
<li>Resolve attributes at release time for a given application only using the <code>MyJson</code> attribute repository.</li>
<li>Turn on global caching of attributes for <code>5</code> seconds and service-level caching for <code>30</code> seconds.</li>
</ul>
<p>The relevant properties for this use case are:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.expirationTime=5
cas.authn.attributeRepository.expirationTimeUnit=seconds
cas.authn.attributeRepository.merger=multivalued

cas.personDirectory.attributeResolutionEnabled=false
</code></pre>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.cache.CachingPrincipalAttributesRepository",
      "duration" : {
        "@class" : "javax.cache.expiry.Duration",
        "timeUnit" : [ "java.util.concurrent.TimeUnit", "SECONDS" ],
        "expiration" : 30
      },
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]]
    }
  }
}
</code></pre>
<p>Attributes fetched and released for this example application may be updated after <code>30</code> seconds, while the global cache attempts to expire and resolve attributes for other applications after <code>5</code> seconds.</p>
<h2>
<a id="4" class="anchor" href="#4" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4</h2>
<p>The requirements for this use case are as follows:</p>
<ul>
<li>Enable attribute resolution from external attribute repositories via Person Directory.</li>
<li>However, let CAS resolve attributes from our <code>StaticStub</code> attribute repository.</li>
<li>Resolve attributes at release time for a given application only using the <code>MyJson</code> attribute repository.</li>
<li>Combine all attributes into one collection as multi-valued attributes where necessary.</li>
<li>Turn on global caching of attributes for <code>30</code> seconds.</li>
</ul>
<p>The relevant properties for this use case are:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.expirationTime=30
cas.authn.attributeRepository.expirationTimeUnit=seconds
cas.authn.attributeRepository.merger=multivalued

cas.personDirectory.attributeResolutionEnabled=true
cas.personDirectory.activeAttributeRepositoryIds=StaticStub
</code></pre>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.DefaultPrincipalAttributesRepository",
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]],
      "mergingStrategy" : "MULTIVALUED"
    }
  }
}
</code></pre>
<h2>
<a id="5" class="anchor" href="#5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5</h2>
<p>The requirements for this use case are identical to the one above. The only difference is, we are going to ignore attributes resolved at authentication time from our <code>StaticSub</code> attribute repository for the example application and only hit our selected attribute repository, <code>MyJson</code>.</p>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.DefaultPrincipalAttributesRepository",
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]],
      "ignoreResolvedAttributes": true,
      "mergingStrategy" : "MULTIVALUED"
    }
  }
}
</code></pre>
<h2>
<a id="6" class="anchor" href="#6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>6</h2>
<p>The requirements for this use case are as follows:</p>
<ul>
<li>Enable attribute resolution from external attribute repositories via Person Directory.</li>
<li>However, let CAS resolve attributes from our <code>StaticStub</code> attribute repository.</li>
<li>Resolve attributes at release time for a given application only using the <code>MyJson</code> attribute repository.</li>
<li>Combine all attributes into one collection as multi-valued attributes where necessary.</li>
<li>Turn on global caching of attributes for <code>30</code> seconds, and service-level caching for <code>30</code> minutes.</li>
</ul>
<p>The relevant properties for this use case are:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.expirationTime=10
cas.authn.attributeRepository.expirationTimeUnit=seconds
cas.authn.attributeRepository.merger=multivalued

cas.personDirectory.attributeResolutionEnabled=true
cas.personDirectory.activeAttributeRepositoryIds=StaticStub
</code></pre>
<p>Our service definition matches the following:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://app.example.org",
  "name" : "ExampleApplication",
  "id" : 1,
  "attributeReleasePolicy" : {
    "@class" : "org.apereo.cas.services.ReturnAllAttributeReleasePolicy",
    "principalAttributesRepository" : {
      "@class" : "org.apereo.cas.authentication.principal.cache.CachingPrincipalAttributesRepository",
      "duration" : {
        "@class" : "javax.cache.expiry.Duration",
        "timeUnit" : [ "java.util.concurrent.TimeUnit", "MINUTES" ],
        "expiration" : 30
      },
      "attributeRepositoryIds": ["java.util.HashSet", [ "myjson" ]]
    }
  }
}
</code></pre>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please know that all other use cases, scenarios, features and theories certainly <a href="https://apereo.github.io/2017/02/18/onthe-theoryof-possibility/">are possible</a> as well. Feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>