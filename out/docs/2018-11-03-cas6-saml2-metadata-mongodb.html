<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---saml2-metadata-with-mongodbsummary----cas-distributed-saml2-metadata-management-using-mongodb-where-you-learn-how-to-store-metadata-documents-inside-mongodb-for-cas-as-a-saml2-identity-provider-and-all-other-registered-saml2-service-providerstags-------cassaml" class="anchor" href="#layout-----posttitle------apereo-cas---saml2-metadata-with-mongodbsummary----cas-distributed-saml2-metadata-management-using-mongodb-where-you-learn-how-to-store-metadata-documents-inside-mongodb-for-cas-as-a-saml2-identity-provider-and-all-other-registered-saml2-service-providerstags-------cassaml" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - SAML2 Metadata with MongoDb<br>
summary:    CAS distributed SAML2 metadata management using MongoDB, where you learn how to store metadata documents inside MongoDB for CAS as a SAML2 identity provider and all other registered SAML2 service providers.<br>
tags:       [CAS,SAML]</h2>
<!-- raw HTML omitted -->
<p><a href="https://www.mongodb.com">MongoDB</a> is a free and open-source cross-platform document-oriented database program. Classified as a NoSQL database program, MongoDB uses JSON-like documents with schemata and is supported in CAS in many different ways. In this walkthrough, we are going to take a pass at getting <a href="https://apereo.github.io/cas/development/installation/Configuring-SAML2-DynamicMetadata.html#mongodb">CAS connected to MongoDB</a> to store SAML2 identity provider <em>and</em> service provider metadata documents.</p>
<p>Our starting position is based on the following:</p>
<ul>
<li>CAS <code>6.0.0-RC4</code>
</li>
<li>Java 11</li>
<li>
<a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a> (The <code>master</code> branch specifically)</li>
<li><a href="https://www.docker.com/get-started">Docker</a></li>
</ul>
<h2>
<a id="mongodb" class="anchor" href="#mongodb" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MongoDB</h2>
<p>To run MongoDB for development and testing, we can use the provided Docker image:</p>
<pre lang="bash"><code>docker run -d -p 27017:27017 -e MONGO_INITDB_ROOT_USERNAME=root \
  -e MONGO_INITDB_ROOT_PASSWORD=secret --name="mongodb-server" mongo:4.0-xenial
docker ps
</code></pre>
<p>This runs a MongoDB database server which is useful for development but <strong>SHOULD NOT</strong> be used in production.</p>
<p>To access the MongoDB instance using a UI, run:</p>
<pre lang="bash"><code>docker run --link mongodb-server -d -p 8081:8081 \
  -e 'ME_CONFIG_MONGODB_ADMINUSERNAME=root' \
  -e 'ME_CONFIG_MONGODB_ADMINPASSWORD=secret' \
  -e 'ME_CONFIG_MONGODB_SERVER=mongodb-server' mongo-express
</code></pre>
<p>The <code>ME_CONFIG_MONGODB_SERVER</code> is the address of the docker container that runs the MongoDB server. By default, Docker containers use the container as the DNS host name. So we can just specify the <code>mongodb-server</code> the name of the container that runs our MongoDB instance.</p>
<p>Shell into the container:</p>
<pre lang="bash"><code>CID=docker ps -aqf name=mongodb-server
docker exec -it $CID /bin/bash
</code></pre>
<p>When inside the container:</p>
<pre lang="bash"><code>mongo --host mongodb://root:secret@localhost:27017
use database cas;

# Create a database user for authentication
db.createUser({user:"casuser", pwd:"Mellon", roles: ["readWrite", "dbAdmin"]})
</code></pre>
<p>Point your browser to <code>http://localhost:8081</code> and let's create a collection called <code>cas-saml-sp-metadata</code> with the following document:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/47908722-10576a80-dea3-11e8-82e1-b812c085d1c0.png" alt="image"></p>
<p>Note the <code>value</code> field which contains a base64-encoded version of the metadata for a SAML2 service provider which makes it easier to get the metadata added to the MongoDB document. I am also skipping over the metadata signature that would have been used to validate its integrity and that could have just as easily been added to the document using a <code>signature</code> field.</p>
<p>That should do for now. Let's get CAS running.</p>
<h2>
<a id="cas" class="anchor" href="#cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CAS</h2>
<h3>
<a id="saml2-service-provider-metadata" class="anchor" href="#saml2-service-provider-metadata" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML2 Service Provider Metadata</h3>
<p>So in order to enable a CAS integration with MongoDB <em>directly</em>, you want to start with the <a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a>, clone the project and follow <a href="https://apereo.github.io/cas/development/installation/Configuring-SAML2-Authentication.html">the notes here</a> to get CAS acting as SAML2 identity provider. In its simplest form, it comes to down to the following settings:</p>
<pre lang="properties"><code>cas.authn.samlIdp.entityId=https://sso.example.org/idp
cas.authn.samlIdp.scope=example.org
cas.authn.samlIdp.metadata.location=file:/etc/cas/config/saml
</code></pre>
<p>...and this module in the CAS build:</p>
<pre lang="gradle"><code>compile "org.apereo.cas:cas-server-support-saml-idp:${project.'cas.version'}"
</code></pre>
<p>To keep things simple, we could use the <a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON service registry</a> to manage our SAML2 service provider definitions. Here is what our service definition might look like for SAML2 service provider in a <code>SAML-1.json</code> file:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId" : "&lt;your-sp-entity-id&gt;",
  "name" : "SAML",
  "id" : 1,
  "description" : "This SP has its metadata in MongoDB somewhere.",
  "metadataLocation" : "mongodb://"
}
</code></pre>
<p>The metadata location in the registration record above simply needs to be specified as <code>mongodb://</code> to signal to CAS that SAML metadata for our service provider must be fetched from MongoDB data sources defined in CAS configuration. As the next step, let's <a href="https://apereo.github.io/cas/development/installation/Configuring-SAML2-DynamicMetadata.html#mongodb">teach CAS</a>) about our MongoDB setup. Just like before, you'd need this module in your CAS build:</p>
<pre lang="gradle"><code>compile "org.apereo.cas:cas-server-support-saml-idp-metadata-mongo:${project.'cas.version'}"
</code></pre>
<p>...and CAS needs to know how to connect to MongoDB to fetch stuff:</p>
<pre lang="properties"><code>cas.authn.samlIdp.metadata.mongo.host=localhost
cas.authn.samlIdp.metadata.mongo.port=27017
cas.authn.samlIdp.metadata.mongo.userId=casuser
cas.authn.samlIdp.metadata.mongo.password=Mellon
cas.authn.samlIdp.metadata.mongo.collection=cas-saml-sp-metadata
cas.authn.samlIdp.metadata.mongo.databaseName=cas
</code></pre>
<p>That's it. Build and run CAS. At this point, you should be able to log into service provider successfully whose metadata is fetched and processed by CAS from MongoDB.</p>
<h3>
<a id="saml2-identity-provider-metadata" class="anchor" href="#saml2-identity-provider-metadata" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SAML2 Identity Provider Metadata</h3>
<p>If you examine your CAS startup logs, you might notice the following statement:</p>
<pre lang="bash"><code>[...FileSystemSamlIdPMetadataLocator] - &lt;Metadata directory location is at [/etc/cas/config/saml]&gt;
</code></pre>
<p>...which matches our setting above:</p>
<pre lang="properties"><code>cas.authn.samlIdp.metadata.location=file:/etc/cas/config/saml
</code></pre>
<p>Metadata artifacts that belong to CAS as a SAML2 identity provider may also be managed and stored via MongoDb. This includes things such as the metadata XML document, signing and encryption keys, etc. While CAS has the ability to generate brand new metadata in MongoDB, let's instead figure out how our existing metadata might be relocated to MongoDB.</p>
<p>Let's create a MongoDB collection called <code>saml-idp-metadata</code> in our <code>cas</code> database to hold IdP artifacts with the following document in it:</p>
<pre lang="json"><code>{
    "signingCertificate": "...",
    "signingKey": "...",
    "encryptionCertificate": "...",
    "encryptionKey": "...",
    "metadata": "..."
}
</code></pre>
<p>Here is the drill:</p>
<ul>
<li>The metadata, signing and encryption <em>certificates</em> may be base64-encoded.</li>
<li>The signing and encryption <em>keys</em> <strong>MUST</strong> be signed and encrypted using CAS crypto settings and keys.</li>
</ul>
<p>The signing secret key and the encryption secret key are both JWKs of size 512 and 256. We can use the <a href="https://apereo.github.io/cas/development/installation/Configuring-Commandline-Shell.html">command-line shell</a> to create the two keys:</p>
<pre lang="bash"><code>cas&gt; generate-key key-size 512
$signingKey
cas&gt; generate-key key-size 256
$encryptionKey
</code></pre>
<p>Once you have the keys, you can try to secure the metadata keys:</p>
<pre lang="bash"><code>cas&gt; cipher-text file /etc/cas/config/saml/idp-signing.key signing-key $signingKey encryption-key $encryptionKey
...
cas&gt; cipher-text file /etc/cas/config/saml/idp-encryption.key signing-key $signingKey encryption-key $encryptionKey
...
</code></pre>
<p>The signing and encryption SAML2 metadata keys plus the base64-encoded versions of the signing and encryption certificates and the metadata XML can next be put into the MongoDB document.</p>
<p><img src="https://user-images.githubusercontent.com/1205228/47927581-f2a4f800-ded8-11e8-8180-5e299be02114.png" alt="image"></p>
<p>CAS settings will then take on the following form:</p>
<pre lang="properties"><code># cas.authn.samlIdp.metadata.location=file:/etc/cas/config/saml
cas.authn.samlIdp.metadata.mongo.idpMetadataCollection=saml-idp-metadata
cas.authn.samlIdp.metadata.mongo.crypto.encryption.key=$encryptionKey
cas.authn.samlIdp.metadata.mongo.crypto.signing.key=$signingKey
</code></pre>
<p>Build and run CAS. At this point, you should be able to log into the service provider successfully with CAS using its own SAML2 metadata from MongoDB to produce a SAML2 response, etc.</p>
<h2>
<a id="finale" class="anchor" href="#finale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finale</h2>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>