<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---delegated-authentication-to-saml2-identity-providerssummary----learn-how-your-apereo-cas-deployment-may-be-configured-to-delegate-authentication-to-an-external-saml2-identity-providertags-------cassaml" class="anchor" href="#layout-----posttitle------apereo-cas---delegated-authentication-to-saml2-identity-providerssummary----learn-how-your-apereo-cas-deployment-may-be-configured-to-delegate-authentication-to-an-external-saml2-identity-providertags-------cassaml" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Delegated Authentication to SAML2 Identity Providers<br>
summary:    Learn how your Apereo CAS deployment may be configured to delegate authentication to an external SAML2 identity provider.<br>
tags:       [CAS,SAML]</h2>
<!-- raw HTML omitted -->
<p>Apereo CAS has had support to <a href="https://apereo.github.io/cas/development/integration/Delegate-Authentication.html">delegate authentication to external SAML2 identity providers</a> for quite some time. This functionality, if memory serves me correctly, started around CAS <code>3.x</code> as an extension based on the <a href="https://github.com/pac4j/pac4j">pac4j</a> project which then later found its way into the CAS codebase as a first class feature. Since then, the functionality more or less has evolved to allow the adopter less configuration overhead and fancier ways to automated workflows.</p>
<p>Of course, <em>delegation</em> is just a fancy word that ultimately means, whether automatically or at the click of a button, the browser is expected to redirect the user to the appropriate SAML2 endpoint and on the return trip back, CAS is tasked to parse the response and extract attributes, etc in order to establish an authentication session, issue tickets, etc. In other words, in delegated scenarios, the main identity provider is an external system and CAS simply begins to act as a client or <em>proxy</em> in between.</p>
<p>In the most common use case, CAS is made entirely invisible to the end-user such that the redirect simply happens automatically and as far as the audience is concerned, there are only the external identity provider and the target application that is, of course, prepped to speak the CAS protocol.</p>
<p>Let's begin. Our starting position is based on:</p>
<ul>
<li>CAS <code>6.1.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
</ul>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>The initial setup is in fact simple; as the <a href="https://apereo.github.io/cas/development/integration/Delegate-Authentication.html">documentation describes</a> you simply need to add the required dependency in your overlay:</p>
<pre lang="xml"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
  &lt;artifactId&gt;cas-server-support-pac4j-webflow&lt;/artifactId&gt;
  &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>...and then in your <code>cas.properties</code>, instruct CAS to hand off authentication to the SAML2 identity provider:</p>
<pre lang="properties"><code>cas.authn.pac4j.saml[0].keystorePassword=pac4j-demo-passwd
cas.authn.pac4j.saml[0].privateKeyPassword=pac4j-demo-passwd
cas.authn.pac4j.saml[0].keystorePath=/etc/cas/config/samlKeystore.jks
cas.authn.pac4j.saml[0].serviceProviderEntityId=urn:mace:saml:pac4j.org
cas.authn.pac4j.saml[0].serviceProviderMetadataPath=/etc/cas/config/sp-metadata.xml

cas.authn.pac4j.saml[0].identityProviderMetadataPath=https://dev.oktapreview.com/app/.../sso/saml/metadata
cas.authn.pac4j.saml[0].clientName=SAML2Client

# cas.authn.pac4j.saml[0].destinationBinding=urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST
# cas.authn.pac4j.saml[0].maximumAuthenticationLifetime=3600
</code></pre>
<p>The above settings instruct CAS to:</p>
<ul>
<li>Generate the service-provider metadata at <code>/etc/cas/config/sp-metadata.xml</code> using entity id <code>urn:mace:saml:pac4j.org</code> automatically. This metadata is created on CAS startup once the login page is rendered. This metadata is expected to be shared <em>somehow</em> with the SAML2 identity provider.</li>
<li>The URL to the identity provider metadata is also taught to CAS; note that in this case, we are using Okta as the SAML2 external identity provider.</li>
</ul>
<p>...and just to make things more interesting, I am going to create a <em>stub</em> attribute definition for <code>employeeNumber</code> with an always-hardcoded value of <code>4095712</code>:</p>
<pre lang="properties"><code>cas.authn.attributeRepository.stub.attributes.employeeNumber=4095712
</code></pre>
<p>This is going to be rather interesting because I have also configured my Okta SAML2 IdP to release an attribute named <code>employeeNumber</code>. Let's see what happens with two systems competing for the same attribute.</p>
<h2>
<a id="da-test" class="anchor" href="#da-test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Da Test</h2>
<p>If you build and then bring up CAS, the main login screen might look something like this:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53325646-05d13e80-38a1-11e9-99fb-1a7346717641.png" alt="image"></p>
<p>Getting to the <code>SAML2Client</code> will redirect you to the Okta SAML2 IdP:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53325664-11246a00-38a1-11e9-8203-ef533c176977.png" alt="image"></p>
<p>After authentication, CAS might greet with you with a <em>Hey! You logged in successfully</em> message. Note that this message shows up because we didn't originally specify a target application, with a <code>service</code> parameter perhaps, when we first accessed CAS.</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53325689-1aadd200-38a1-11e9-9418-b046f629d14c.png" alt="image"></p>
<p>If you expand the link to see attributes currently resolved, you will see everything the identity provider has released to CAS as a service provider. Interestingly, CAS has also merged the values for <code>employeeNumber</code>, effectively turning it into a multi-valued attribute honor both sources of attributes.</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53325713-27cac100-38a1-11e9-94a4-363b3ec64cc5.png" alt="image"></p>
<h2>
<a id="remap-attributes" class="anchor" href="#remap-attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remap Attributes</h2>
<p>To make things more exiciting, let's instruct CAS to fetch the attribute <code>employeeNumber</code> from the identity provider<br>
and then virtually rename it to <code>empl_id</code>:</p>
<pre><code>cas.authn.pac4j.saml[0].mappedAttributes[0].name=employeeNumber
cas.authn.pac4j.saml[0].mappedAttributes[0].mappedTo=empl_id
</code></pre>
<p>With those settings, if you go through the same sequence again you might see something like this:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53326019-ce16c680-38a1-11e9-8778-e8232de3d575.png" alt="image"></p>
<!-- raw HTML omitted -->
<h2>
<a id="identity-provider-authorization" class="anchor" href="#identity-provider-authorization" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Identity Provider Authorization</h2>
<p>Let's pretend that we are using the <a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON Service Registry</a> to manage our application registration records. On a per-app basis and for a sample test application, let's make sure our app is authorized to use our SAML2 identity provider in a delegated authentication scenario.</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://www.example.org",
  "name" : "Example",
  "id" : 1,
  "evaluationOrder" : 1,
  "accessStrategy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy",
    "delegatedAuthenticationPolicy" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceDelegatedAuthenticationPolicy",
      "allowedProviders" : [ "java.util.ArrayList", [ "SAML2Client" ] ]
    }
  }
}
</code></pre>
<!-- raw HTML omitted -->
<h2>
<a id="service-access-strategy" class="anchor" href="#service-access-strategy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Service Access Strategy</h2>
<p>We know our identity provider is releasing a handful of attributes to CAS. Let's play around with CAS access strategies and design a rule for our example application to only grant entry access to the application if CAS has access to a <code>memberOf</code> attribute with a value of <code>Administrator</code>. We know of course that the identity provider is not releasing this attribute yet, so we promptly should be greeted with a <em>Sorry you are not allowed to proceed</em> type of error message.</p>
<p>Our application policy would look similar to this:</p>
<pre lang="json"><code>{
  "@class" : "org.apereo.cas.services.RegexRegisteredService",
  "serviceId" : "https://www.example.org",
  "name" : "Example",
  "id" : 1,
  "evaluationOrder" : 1,
  "accessStrategy" : {
    "@class" : "org.apereo.cas.services.DefaultRegisteredServiceAccessStrategy",
    "requiredAttributes" : {
      "@class" : "java.util.HashMap",
      "memberOf" : [ "java.util.HashSet", [ "Administrator" ] ]
    },
    "delegatedAuthenticationPolicy" : {
      "@class" : "org.apereo.cas.services.DefaultRegisteredServiceDelegatedAuthenticationPolicy",
      "allowedProviders" : [ "java.util.ArrayList", [ "SAML2Client" ] ]
    }
  }
}
</code></pre>
<p>Now, if you try the same sequence again, (don't forget to start with the application), you'd be greeted at the end of the flow with:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/53349255-f7534900-38d9-11e9-84b4-ca80072d6927.png" alt="image"></p>
<h2>
<a id="finale" class="anchor" href="#finale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finale</h2>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>