<hr>
<p>layout:     post<br>
title:      Apereo CAS - Webflow Decorations<br>
summary:    Learn how you may decorate the Apereo CAS login webflow to inject data pieces and objects into the processing engine for display purposes, peace on earth and prosperity of all mankind, etc. Mainly, etc.</p>
<h2>
<a id="tags-------cas" class="anchor" href="#tags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>There are times where you may need to modify the CAS login webflow to include additional pieces of data, typically fetched from outside resources and endpoints. Examples include displaying announcements on the CAS login screen or calling a REST API to fetch today's Cafeteria menu, etc. While the webflow itself can certainly be extended in many fancy ways, one easy option is to let CAS <em>decorate</em> the login webflow automatically by reaching out outside sources to fetch data while taking care of the internal webflow configuration and injections on its own. Of course, once data is fetched and made available to CAS you still have the responsibility of using that data to properly display it in the appropriate view and style it correctly...and that's what we are going to do here!</p>
<p>Our use case is such:</p>
<ul>
<li>Examine the incoming application URL that has submitted a login request to CAS.</li>
<li>If it's an <code>https</code> URL, display a message on the screen to reassure the user of their security and safety.</li>
<li>If it's <em>NOT</em> an <code>https</code> URL, display a message on the screen anyway to frighten and notify the user!</li>
</ul>
<p>Our starting position is based on:</p>
<ul>
<li>CAS <code>6.1.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
<li><a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON Service Registry</a></li>
</ul>
<h1>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h1>
<p>Imagine we have the following service definition registered with CAS:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.services.RegexRegisteredService",
  "serviceId": "^https://.*",
  "name": "HTTPS and IMAPS",
  "id": 10000001,
  "description": "This service definition authorizes all application urls that support HTTPS and IMAPS protocols.",
}
</code></pre>
<p>The <code>serviceId</code> field above indicates that all URLs starting with <code>https://</code> are recognized by our CAS server. Later on, we may relax this pattern to allow <code>http</code>-based URLs as well so as to allow our logic for URL detection and follow-up messages on the screen.</p>
<p>Next, we are going to teach CAS about the location of a script that would handle the execution of our use case and conditions:</p>
<pre lang="properties"><code>cas.webflow.login-decorator.groovy.location=file:/path/to/GroovWebflowDecorator.groovy
</code></pre>
<p>...of course, our Groovy script would be:</p>
<pre lang="groovy"><code>import java.util.*
import java.io.*
import org.apereo.cas.web.support.*

def run(Object[] args) {
    def requestContext = args[0]
    def applicationContext = args[1]
    def logger = args[2]

    def service = WebUtils.getService(requestContext)
    logger.info("Decorating the login view for ${service}")
    if (service != null) {
        if (service.id.startsWith("https://")) {
            requestContext.flowScope.put("decoration", 
                new Decoration(title: "decoration.title.secure",
                            description: "decoration.description.secure"))
        } else {
            requestContext.flowScope.put("decoration", 
                new Decoration(title: "decoration.title.insecure",
                            description: "decoration.description.insecure"))
        }
    }
}

class Decoration implements Serializable {
    private static final long serialVersionUID = 8517547235465666978L
    String title
    String description
}
</code></pre>
<p>The above script simply attempts to stuff a <code>Decoration</code> object into the webflow using the lookup key <code>decoration</code>. Our object carries two fields for <code>title</code> and <code>description</code> that point to keys in our language bundles. The webflow will be decorated based on the incoming service and our condition therein, exposing access to our data object under the key <code>decoration</code>, which can then be used in CAS views to display data, etc.</p>
<p>Mainly, etc.</p>
<!-- raw HTML omitted -->
<p>Of course, the CAS message/language bundle (typically <code>custom_messages.properties</code> file) should also contain the text for our message keys/codes as well:</p>
<pre lang="properties"><code>decoration.title.secure=Secured!
decoration.title.insecure=Insecure!

decoration.description.secure=This application runs behind https.
decoration.description.insecure=This application runs behind http!
</code></pre>
<p>At this point, the webflow is properly decorated with the data we need to display. All we have to do is find a relevant CAS view and display that data, perhaps in <code>serviceui.html</code> somewhere:</p>
<pre lang="html"><code>&lt;div th:if="${decoration}"&gt;
    &lt;h3 th:utext="#{${decoration.title}}" /&gt;
    &lt;p th:utext="#{${decoration.description}}" /&gt;
&lt;/div&gt;
</code></pre>
<p>That should do it.</p>
<h1>
<a id="test" class="anchor" href="#test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test</h1>
<p>If you attempt to access CAS using an application that does in fact run behind <code>https</code>, the following picture is what you should expect:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/56655233-0b4fc880-6647-11e9-8a41-7fccdde920e5.png" alt="image"></p>
<p>Next, if you relax the <code>serviceId</code> requirement to allow for <code>http</code> applications as well, you might see the following outcome:</p>
<p><img src="https://user-images.githubusercontent.com/1205228/56655214-fecb7000-6646-11e9-9076-d73db686ccaa.png" alt="image"></p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please know that all other use cases, scenarios, features, and theories certainly <a href="https://apereo.github.io/2017/02/18/onthe-theoryof-possibility/">are possible</a> as well. Feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>