<hr>
<h2>
<a id="layout-----posttitle------cas-5-ldap-authn-and-jasypt-configurationsummary----learn-how-to-configure-ldap-authn-with-cas-and-secure-ldap-credentials-via-jasypttags-------cas" class="anchor" href="#layout-----posttitle------cas-5-ldap-authn-and-jasypt-configurationsummary----learn-how-to-configure-ldap-authn-with-cas-and-secure-ldap-credentials-via-jasypttags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      CAS 5 LDAP AuthN and Jasypt Configuration<br>
summary:    Learn how to configure LDAP AuthN with CAS and secure LDAP credentials via Jasypt.<br>
tags:       [CAS]</h2>
<p>This is a short and sweet tutorial on how to configure CAS for LDAP authentication and secure bind credentials via Jasypt encryption.<br>
Most of the material is based on the available documentation <a href="https://apereo.github.io/cas/development/installation/Configuration-Properties-Security.html">here</a> and <a href="https://apereo.github.io/cas/development/installation/LDAP-Authentication.html">here</a>.</p>
<p>This tutorial specifically focuses on:</p>
<ul>
<li>CAS <code>5.1.0-RC3-SNAPSHOT</code>
</li>
<li>Java 8</li>
<li>Docker 1.13.x</li>
<li>Apache Tomcat <code>8.5.x</code>
</li>
<li>
<a href="http://www.jasypt.org/cli.html">Jasypt CLI</a>. You can download the distribution <a href="http://www.jasypt.org/download.html">from here</a>.</li>
</ul>
<p>This tutorial assumes that you are running CAS in its <code>standalone</code> mode, <a href="https://apereo.github.io/cas/development/installation/Configuration-Server-Management.html">described here</a>.</p>
<h1>
<a id="ldap-setup" class="anchor" href="#ldap-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LDAP Setup</h1>
<p>For this tutorial, I am using a 398-ds LDAP server <a href="https://github.com/jtgasper3/docker-images/tree/master/389-ds">from this docker image</a>.<br>
Once you have the image running, you can connect to the underlying LDAP server at <code>localhost:10389</code> with <code>cn=Directory Manager</code> and <code>password</code>. The LDAP server is also prepped with a <code>users.ldif</code> file that contains the test account <code>jsmith:password</code>.</p>
<pre lang="bash"><code>docker ps

CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                    NAMES
0f2a75441fb5        jtgasper3/389ds-basic   "/bin/sh -c '/usr/..."   11 days ago         Up 6 minutes        0.0.0.0:10389-&gt;389/tcp   ldap-server
</code></pre>
<p>Sweet! Moving on...</p>
<h1>
<a id="deploy-cas" class="anchor" href="#deploy-cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deploy CAS</h1>
<p>Hop over to <a href="https://apereo.github.io/cas/development/installation/Maven-Overlay-Installation.html">the overlay installation</a> and get CAS built and deployed. The CAS version I am using today is <code>5.1.0-RC3-SNAPSHOT</code>. It does not matter whether you end up using Maven or Gradle. Choose what fits you best. When you have a baseline functioning build, continue on.</p>
<h1>
<a id="configure-cas" class="anchor" href="#configure-cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure CAS</h1>
<p>Once you have added the LDAP module to your build as is described <a href="https://apereo.github.io/cas/development/installation/LDAP-Authentication.html">here</a>, you then need to teach CAS about the running LDAP server.</p>
<p>Here is what I did in the <code>cas.properties</code> file, along with all the other usual suspects:</p>
<pre lang="properties"><code>cas.authn.ldap[0].type=AUTHENTICATED
cas.authn.ldap[0].ldapUrl=ldap://localhost:10389
cas.authn.ldap[0].useSsl=false
cas.authn.ldap[0].baseDn=ou=People,dc=example,dc=edu
cas.authn.ldap[0].userFilter=uid={user}
cas.authn.ldap[0].bindDn=cn=Directory Manager
cas.authn.ldap[0].bindCredential=password
</code></pre>
<p>I also need to disable static authentication. It would also be very nice if I could turn on <code>DEBUG</code> logs and see what CAS attempts to do:</p>
<pre lang="properties"><code>logging.level.org.apereo=DEBUG
cas.authn.accept.users=
</code></pre>
<h1>
<a id="build-and-deploy" class="anchor" href="#build-and-deploy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build and Deploy</h1>
<p>Once you get CAS built and deployed, logs should indicate something like this:</p>
<pre lang="bash"><code>2017-03-22 16:01:06,915 INFO [o.a.c.c.LdapAuthenticationConfiguration] - &lt;Ldap authentication for [LdapAuthenticationHandler] is to chain principal resolvers via [[org.apereo.cas.authentication.principal.resolvers.ChainingPrincipalResolver@1452f4cb[chain=[org.apereo.cas.authentication.principal.resolvers.PersonDirectoryPrincipalResolver@1b7c5e6a[returnNullIfNoAttributes=false,principalAttributeName=&lt;null&gt;], org.apereo.cas.authentication.principal.resolvers.EchoingPrincipalResolver@6824495c[]]]]] for attribute resolution&gt;
</code></pre>
<p>Great. Next, pull up CAS in your browser and log in with <code>jsmith</code> and <code>password</code> and you should be in. Viola!</p>
<h1>
<a id="jasypt-encryption" class="anchor" href="#jasypt-encryption" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Jasypt Encryption</h1>
<p>You may have noted that the LDAP <code>bindCredential</code> is put into the <code>cas.properties</code> file in plain-text. As the next steps:</p>
<ul>
<li>We will first encrypt the <code>bindCredential</code> value via Jasypt and put it into CAS.</li>
<li>We will instruct CAS to decrypt the setting at runtime invisibly and resume as usual.</li>
</ul>
<p>Note that there is nothing stopping you from encrypting any other setting!</p>
<h2>
<a id="encrypt-via-jasypt" class="anchor" href="#encrypt-via-jasypt" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Encrypt via Jasypt</h2>
<p>Once you download the <a href="http://www.jasypt.org/cli.html">Jasypt CLI</a>, at a minimum you need to decide which algorithm you want to use for encryption and what your encryption key/password should be which is the thing that is later taught to CAS to decode the value. In the <code>bin</code> directory of the distribution, you can invoke <code>./listAlgorithms.sh|bat</code> to see what may be possible for algorithms and then use the <code>./encrypt.sh|bat</code> to encrypt values.</p>
<p>So for me to encrypt the value of <code>bindCredential</code>, I ran the following command:</p>
<pre lang="bash"><code>./encrypt.sh input=password algorithm=PBEWithMD5AndTripleDES password=MySuperPassword

----ENVIRONMENT-----------------
Runtime: Oracle Corporation Java HotSpot(TM) 64-Bit Server VM 25.121-b13 

----ARGUMENTS-------------------
algorithm: PBEWithMD5AndTripleDES
input: password
password: MySuperPassword

----OUTPUT----------------------
mqWuN+/U7oofNhdSVNcEgmVcwGmxiOaS
</code></pre>
<p>I can also confirm that this value can be decoded as well:</p>
<pre lang="bash"><code>./decrypt.sh input=mqWuN+/U7oofNhdSVNcEgmVcwGmxiOaS algorithm=PBEWithMD5AndTripleDES password=MySuperPassword

----ENVIRONMENT-----------------
Runtime: Oracle Corporation Java HotSpot(TM) 64-Bit Server VM 25.121-b13 

----ARGUMENTS-------------------
algorithm: PBEWithMD5AndTripleDES
input: mqWuN+/U7oofNhdSVNcEgmVcwGmxiOaS
password: MySuperPassword

----OUTPUT----------------------
password
</code></pre>
<p>Cool. Let's move on.</p>
<h2>
<a id="configure-cas-1" class="anchor" href="#configure-cas-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configure CAS</h2>
<p>So now that I have encrypted value in the <code>OUTPUT</code> section, I am going to slightly massage my configuration as such:</p>
<pre lang="properties"><code>...
cas.authn.ldap[0].bindCredential={cipher}mqWuN+/U7oofNhdSVNcEgmVcwGmxiOaS
...
</code></pre>
<p>Finally, we need to teach CAS to handle the reverse of this operation. Consulting the docs <a href="https://apereo.github.io/cas/development/installation/Configuration-Properties-Security.html">here</a>, I ended up adjusting my configuration as such:</p>
<pre lang="properties"><code>cas.standalone.config.security.alg=PBEWithMD5AndTripleDES
</code></pre>
<p>Using the embedded tomcat container, I configured my "run CAS" command to pass along the encryption key as a command-line parameter. If you prefer, you could do the same thing with environment variables and system properties.</p>
<pre lang="bash"><code>java -jar target/cas.war --cas.standalone.config.security.psw=MySuperPassword
</code></pre>
<p>Next time when attempt to deploy and run CAS, you should be able to bind and connect to LDAP and authenticate as before.</p>
<p>That's it!</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>