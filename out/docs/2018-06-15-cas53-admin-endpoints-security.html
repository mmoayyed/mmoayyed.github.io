<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---administrative-endpoints--monitoringsummary----gain-insight-into-your-running-apereo-cas-deployment-in-production-learn-how-to-monitor-and-manage-the-server-by-using-http-endpoints-and-gather-metrics-to-diagnose-issues-and-improve-performancetags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---administrative-endpoints--monitoringsummary----gain-insight-into-your-running-apereo-cas-deployment-in-production-learn-how-to-monitor-and-manage-the-server-by-using-http-endpoints-and-gather-metrics-to-diagnose-issues-and-improve-performancetags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Administrative Endpoints &amp; Monitoring<br>
summary:    Gain insight into your running Apereo CAS deployment in production. Learn how to monitor and manage the server by using HTTP endpoints and gather metrics to diagnose issues and improve performance.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<p>CAS, being a Spring-Boot application at heart, includes a number of additional features to help you monitor and manage the server when it’s pushed to production. You can choose to manage and monitor the deployment using HTTP endpoints, referred to as <em>actuators</em>. This tutorial provides a basic overview of the endpoints provided by both Spring Boot and CAS and also provides instructions on how such endpoints can be secured for access and win.</p>
<p>This tutorial specifically requires and focuses on:</p>
<ul>
<li>CAS <code>5.3.x</code>
</li>
<li>Java 8</li>
<li><a href="https://stedolan.github.io/jq/">CLI JSON Processor <code>jq</code></a></li>
<li><a href="https://apereo.github.io/cas/development/installation/Maven-Overlay-Installation.html">Maven WAR Overlay</a></li>
</ul>
<h1>
<a id="actuawhat" class="anchor" href="#actuawhat" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Actua...What?</h1>
<p>In essence, actuator endpoints bring production-ready features to CAS. Monitoring a running CAS instance, gathering metrics, understanding traffic or the state of our database becomes trivial with such endpoints. The main benefit of these endpoints is that we can get production grade tools without having to actually implement these features ourselves. Actuators are mainly used to expose operational information about the running application – health, metrics, info, dump, env, etc. These are HTTP endpoints or JMX beans to enable us to interact with it.</p>
<!-- raw HTML omitted -->
<p>The full list of endpoints provided to your CAS deployment <a href="https://apereo.github.io/cas/development/installation/Monitoring-Statistics.html">is posted here</a>. Note that you do not need to do anything extra special to get these endpoints added to your deployment; these are all available by default and just need to be turned on and secured for access.</p>
<h1>
<a id="endpoints" class="anchor" href="#endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Endpoints</h1>
<p>Each endpoint, whether provided by CAS or Spring Boot, is generally given two special properties:</p>
<ul>
<li>
<code>enabled</code>: Turn on the endpoint and make it available for access by outsiders.</li>
<li>
<code>sensitive</code>: Determines whether endpoint security should be controlled via the likes of <a href="https://spring.io/projects/spring-security">Spring Security</a> with extra configuration.</li>
</ul>
<p>So as an example, if you wish to turn on the <code>status</code> endpoint in CAS you need to simply turn on the following settings:</p>
<pre lang="properties"><code>cas.monitor.endpoints.status.enabled=true
cas.monitor.endpoints.status.sensitive=false
</code></pre>
<p>What the above settings indicate is that the <code>status</code> endpoint should be turned on at runtime and it's one whose security is <em>NOT</em> controlled by the Spring Security library.</p>
<!-- raw HTML omitted -->
<p>So in summary, access to our <code>status</code> endpoint above is purely dictated by CAS itself which by default is controlled by an IP pattern. So here's a rule that allows access to all CAS endpoints from everywhere:</p>
<pre lang="properties"><code>cas.adminPagesSecurity.ip=.+
</code></pre>
<p>Once you have the above in place, simply open up a command prompt and execute:</p>
<pre lang="bash"><code># You might need the -k flag if the server's certificate is untrusted...
$ curl https://login.example.org/cas/status

Health: UP

Host:       misaghmoayyed
Server:     https://login.example.org
Version:    5.3.0
</code></pre>
<h1>
<a id="troubleshooting" class="anchor" href="#troubleshooting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Troubleshooting</h1>
<p>For easier diagnostics, you need to turn on the following logging configuration in your <code>log4j2.xml</code> file:</p>
<pre lang="xml"><code>&lt;AsyncLogger name="org.pac4j" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/AsyncLogger&gt;
&lt;AsyncLogger name="org.springframework.security" level="debug" additivity="false"&gt;
    &lt;AppenderRef ref="console"/&gt;
    &lt;AppenderRef ref="file"/&gt;
&lt;/AsyncLogger&gt;
</code></pre>
<p>...which then help you diagnose issues if access to an endpoint is blocked with:</p>
<pre lang="properties"><code>cas.adminPagesSecurity.ip=192\.168\.3\.1
</code></pre>
<p>...and then when you run:</p>
<pre lang="bash"><code>$ curl https://login.example.org/cas/status | jq
</code></pre>
<p>...you might get:</p>
<pre lang="json"><code>{
  "timestamp": 1529124120075,
  "status": 401,
  "error": "Unauthorized",
  "message": "No message available",
  "path": "/cas/status"
}
</code></pre>
<p>...where the logs would indicate:</p>
<pre lang="bash"><code>INFO [IpClient] - &lt;Failed to retrieve or validate credentials: Unauthorized IP address: 0:0:0:0:0:0:0:1&gt;
DEBUG [IpClient] - &lt;Failed to retrieve or validate credentials&gt;
org.pac4j.core.exception.CredentialsException: Unauthorized IP address: 0:0:0:0:0:0:0:1
    at org.pac4j.http.credentials.authenticator.IpRegexpAuthenticator.validate...
</code></pre>
<h1>
<a id="endpoint-security" class="anchor" href="#endpoint-security" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Endpoint Security</h1>
<p>CAS endpoints prior to the adoption of Spring Boot and family (i.e. CAS v4 and priors) were always protected by an IP pattern which more or less was a regular expression pattern. Today and by default, this same protection mechanism is kept as well where all CAS endpoints are considered disabled whose security is exclusively controlled by the IP pattern noted above. In other words, in the event that access to an endpoint is allowed, (i.e endpoint is enabled and is not marked as sensitive), CAS will attempt to control access by enforcing rules via IP address matching, delegating to itself, etc.</p>
<p>Note that while almost all CAS endpoints can be secured via other means (such as a CAS server), the <code>/status</code> endpoint is always protected by an IP pattern allowing monitoring and CLI tools to easily query the endpoint from a protected recognized IP address.</p>
<h1>
<a id="lets-boot" class="anchor" href="#lets-boot" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let's Boot</h1>
<p>As an exercise, let us enable the Spring Boot's <code>health</code> &amp; <code>info</code> endpoints and compare them with CAS' own <code>status</code> endpoint. We are also going to secure the <code>health</code> endpoint using the <a href="https://spring.io/projects/spring-security">Spring Security library</a> by taking advantage of the basic authentication scheme.</p>
<p>So, the first order of business is to simply enable the endpoints:</p>
<pre lang="properties"><code>cas.adminPagesSecurity.ip=192\.168\.3\.1

endpoints.health.enabled=true
endpoints.health.sensitive=false

endpoints.info.enabled=true
endpoints.info.sensitive=false
</code></pre>
<p>...and with executing a request from a trusted IP address that would match the above pattern:</p>
<pre lang="bash"><code>$ curl https://login.example.org/cas/status/health | jq
</code></pre>
<p>...we shall receive:</p>
<pre lang="json"><code>{
  "status": "UP"
}
</code></pre>
<p>...or we can try the <code>info</code> endpoint too:</p>
<pre lang="bash"><code>$ curl https://login.example.org/cas/status/info | jq
</code></pre>
<p>...which results in a lot of information, summarized here for sanity:</p>
<pre lang="json"><code> "cas": {
    "version": "5.3.0",
    "java": {
      "home": "../jdk1.8.0_171.jdk/Contents/Home/jre",
      "version": "1.8.0_171",
      "vendor": "Oracle Corporation"
    }
  },
  "description": "CAS",
  ...
</code></pre>
<p>Nice. Two questions:</p>
<ul>
<li>How could we get more information from the <code>health</code> endpoint?</li>
<li>Weren't we going to enable basic authentication for some of these endpoints? What happened there?</li>
</ul>
<h1>
<a id="lets-health" class="anchor" href="#lets-health" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let's Health</h1>
<p>According to the documentation, the <code>health</code> endpoint shows application health information (when the application is secure, a simple "status" when accessed over an unauthenticated connection or full message details when authenticated). That has been the case since our requests are not exactly authenticated. We have simply honored the IP rules when submitting requests but we need to take this one step further and ask for credentials. Fancier modes of authenticating requests to such endpoints are provided by Spring Security (a library Spring Boot depends upon to auto-configure the access rules for endpoints marked as <code>sensitive</code>). So, let's get that configured.</p>
<!-- raw HTML omitted -->
<p>The first task is to configure our CAS overlay to include the relevant dependency:</p>
<pre lang="xml"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
  &lt;artifactId&gt;cas-server-webapp-config-security&lt;/artifactId&gt;
  &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>...and then, mark the endpoint as <code>sensitive</code> in our CAS properties:</p>
<pre lang="properties"><code>endpoints.health.enabled=true
endpoints.health.sensitive=true
</code></pre>
<p>Next order of business is to define our <em>master</em> credentials that would be asked of all requests. Note that if the password is left blank, a random password will be generated/printed in the logs by default. We can define our own using the following:</p>
<pre lang="properties"><code>security.user.name=wade
security.user.password=de@dp00L
</code></pre>
<p>With the above settings, if you try the same request as before:</p>
<pre lang="bash"><code>$ curl https://login.example.org/cas/status/health | jq
</code></pre>
<p>...you might see the following:</p>
<pre lang="json"><code>{
  "timestamp": 1529126720131,
  "status": 401,
  "error": "Unauthorized",
  "message": "Full authentication is required to access this resource",
  "path": "/cas/status/health"
}
</code></pre>
<p>So we need to be fully authenticated. Let's present credentials:</p>
<pre lang="bash"><code>$ curl -u wade:de@dp00L https://login.example.org/cas/status/health | jq
</code></pre>
<p>...and the full output shall then be something as follows where CAS presents some additional health information regarding <code>session</code> and <code>memory</code> which correspond to its own health indicators monitoring the runtime memory status as well as the ticket registry repository:</p>
<pre lang="json"><code>{
  "status": "UP",
  "memory": {
    "status": "UP",
    "freeMemory": 3006834288,
    "totalMemory": 3817865216
  },
  "session": {
    "status": "UP",
    "sessionCount": 0,
    "ticketCount": 0,
    "message": "OK"
  },
  "diskSpace": {
    "status": "UP",
    "total": 500068036608,
    "free": 115889942528,
    "threshold": 10485760
  },
  "refreshScope": {
    "status": "UP"
  }
}
</code></pre>
<p>...and if you happen to submit an incorrect authentication request with bad credentials, you might be presented with:</p>
<pre lang="json"><code>{
  "timestamp": 1529127019737,
  "status": 401,
  "error": "Unauthorized",
  "message": "Bad credentials",
  "path": "/cas/status/health"
}
</code></pre>
<p>Of course, this is just basic authentication with a pre-defined pair of credentials. You can get the endpoints secured with a CAS server as well, or you can try basic authentication with an underlying account store backed by LDAP or JDBC...or as always, you can take full advantage of Spring Security in all its glory and design your authentication scheme for the win.</p>
<h1>
<a id="looking-ahead" class="anchor" href="#looking-ahead" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Looking Ahead</h1>
<p>As an FYI, as of this writing, the CAS version at hand depends on Spring Boot <code>1.5.x</code> to deliver endpoints and get them secured. Starting with Spring Boot v2, there is no separate auto-configuration for user-defined endpoints and actuator endpoints. Security is strictly controlled and provided by Spring Security if the library is included in CAS and found on the classpath whereby the auto-configuration secures all endpoints by default. Spring Boot then relies on Spring Security’s content-negotiation strategy to determine whether to use a basic authentication mode or form-based login and just like before, a user with a default username and generated password is added, which can be used to log in.</p>
<p>All of that is to say, endpoint security is one area that might get heavily refactored and redesigned in the future once CAS upgrades to Spring Boot v2. This would basically affect CAS configuration in the way that <code>enabled</code> or <code>sensitive</code> properties are defined; they might get removed or renamed, etc. There will be follow-up announcements and notes on the subject once the upgrade is available in due time and for now.</p>
<h1>
<a id="monitors" class="anchor" href="#monitors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Monitors</h1>
<p>CAS monitors may be defined to report back the health status of the ticket registry and other underlying connections to systems that are in use by CAS. Spring Boot offers a number of monitors known as <code>HealthIndicator</code>s that are activated given the presence of specific settings (i.e. <code>spring.mail.*</code>). CAS itself provides a number of other monitors based on the same component whose action may require a combination of a particular dependency module and its relevant settings.</p>
<p>As you saw in the output of the <code>health</code> endpoint, the default monitors report back brief memory and ticket stats. As an exercise, we shall configure CAS to monitor and report health information on the status of a mail server (the monitor is provided by Spring Boot natively) and we may also let CAS monitor the status of an LDAP server provided where the monitor is this time brought to you by CAS.</p>
<h2>
<a id="mail-server-monitor" class="anchor" href="#mail-server-monitor" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mail Server Monitor</h2>
<p>First, let's get the mail server configured in CAS:</p>
<pre lang="properties"><code>spring.mail.host=localhost
spring.mail.port=25000
spring.mail.testConnection=true
</code></pre>
<p>With the above settings, at runtime CAS begins to create and bootstrap components that need to deal with a mail server and just as well, a special health monitor will get auto-configured to watch the server status and report back results via the <code>health</code> endpoint.</p>
<!-- raw HTML omitted -->
<p>So, let's get us a health report:</p>
<pre lang="bash"><code>$ curl -u wade:de@dp00L https://login.example.org/cas/status/health | jq
</code></pre>
<p>...and we shall receive the same sort of report except for this time we have a small blob for <code>mail</code>:</p>
<pre lang="json"><code>...
"mail": {
    "status": "UP",
    "location": "localhost:25000"
},
...
</code></pre>
<p>...and if you shut the server down, you might receive:</p>
<pre lang="json"><code>...
"mail": {
    "status": "DOWN",
    "location": "localhost:25000",
    "error": "com.sun.mail.util.MailConnectException: Couldn't connect to host, port: localhost, 25000; timeout -1"
},
...
</code></pre>
<h2>
<a id="ldap-monitor" class="anchor" href="#ldap-monitor" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>LDAP Monitor</h2>
<p>First, let's add the following dependency to ensure CAS can connect to an LDAP server:</p>
<pre lang="xml"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;
    &lt;artifactId&gt;cas-server-support-ldap-monitor&lt;/artifactId&gt;
    &lt;version&gt;${cas.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>...and let's teach CAS where our LDAP server lives:</p>
<pre lang="properties"><code>cas.monitor.ldap.ldapUrl=ldap://localhost:389
cas.monitor.ldap.useSsl=false
</code></pre>
<!-- raw HTML omitted -->
<p>So, once again let's get us a health report:</p>
<pre lang="bash"><code>$ curl -u wade:de@dp00L https://login.example.org/cas/status/health | jq
</code></pre>
<p>...and we shall receive the same sort of report except for this time we have a small blob for <code>pooledLdapConnectionFactory</code>:</p>
<pre lang="json"><code>...
"pooledLdapConnectionFactory": {
  "status": "UP",
  "message": "OK",
  "activeCount": 0,
  "idleCount": 3
},
...
</code></pre>
<p>Additional monitors and health indicators may get added in future CAS versions. Consult the CAS documentation for more info.</p>
<h1>
<a id="what-about" class="anchor" href="#what-about" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What About...?</h1>
<ul>
<li><a href="https://fawnoos.com/2018/06/09/cas53-gettingstarted-overlay/">CAS WAR Overlays</a></li>
<li><a href="https://fawnoos.com/2018/01/08/cas-mfa-duosecurity/">CAS Multifactor Authentication with Duo Security</a></li>
<li><a href="https://fawnoos.com/2017/03/24/cas51-ldapauthnjasypt-tutorial/">CAS 5 LDAP AuthN and Jasypt Configuration</a></li>
<li><a href="https://fawnoos.com/2017/03/22/cas51-delauthn-tutorial/">CAS 5 SAML2 Delegated AuthN Tutorial</a></li>
<li><a href="http://fawnoos.com/2018/06/10/cas-userinterface-customizations/">CAS User Interface Customizations</a></li>
<li><a href="https://fawnoos.com/2018/06/10/cas-mfa-google-authenticator/">CAS Multifactor Authentication with Google Authenticator</a></li>
</ul>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>It's important that you start off simple and make changes one step at a time. Once you have a functional environment, you can gradually and slowly add customizations to move files around.</p>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>