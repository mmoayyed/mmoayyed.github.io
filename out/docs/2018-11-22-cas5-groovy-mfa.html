<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---scripting-multifactor-authentication-triggerssummary----learn-how-apereo-cas-may-be-configured-to-trigger-multifactor-authentication-using-groovy-conditionally-decide-whether-mfa-should-be-triggered-for-internal-vs-external-access-taking-into-account-ip-ranges-ldap-groups-etctags-------casmfa" class="anchor" href="#layout-----posttitle------apereo-cas---scripting-multifactor-authentication-triggerssummary----learn-how-apereo-cas-may-be-configured-to-trigger-multifactor-authentication-using-groovy-conditionally-decide-whether-mfa-should-be-triggered-for-internal-vs-external-access-taking-into-account-ip-ranges-ldap-groups-etctags-------casmfa" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - Scripting Multifactor Authentication Triggers<br>
summary:    Learn how Apereo CAS may be configured to trigger multifactor authentication using Groovy conditionally decide whether MFA should be triggered for internal vs. external access, taking into account IP ranges, LDAP groups, etc.<br>
tags:       [CAS,MFA]</h2>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>If you have configured multifactor authentication with CAS with a provider (i.e. <a href="https://apereo.github.io/cas/5.3.x/installation/DuoSecurity-Authentication.html">Duo Security</a>), you may find yourself in need of conditionally triggering MFA based on a variety of factors rather dynamically. Here is a possible scenario:</p>
<ul>
<li>Allow internal access to a service without forcing MFA via IP range</li>
<li>Rejecting external access to a service unless in MFA LDAP group</li>
</ul>
<p>CAS provides a large number of strategies to <a href="https://apereo.github.io/cas/5.3.x/installation/Configuring-Multifactor-Authentication-Triggers.html">trigger multifactor authentication</a>. To deliver the use case, we can take advantage of a Groovy-based trigger to implement said conditions. The script is invoked by CAS globally (regardless of application, user, MFA provider, etc) whose outcome should determine whether an MFA provider can take control of the subsequent step in the authentication flow.</p>
<p>Our starting position is based on the following:</p>
<ul>
<li>CAS <code>5.3.x</code>
</li>
<li>Java <code>8</code>
</li>
<li>
<a href="https://github.com/apereo/cas-overlay-template">Maven Overlay</a> (The <code>5.3</code> branch specifically)</li>
</ul>
<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>
<p>With <a href="https://apereo.github.io/cas/5.3.x/installation/DuoSecurity-Authentication.html">Duo Security</a> configured as our multifactor authentication provider, we can start off with the following settings:</p>
<pre lang="properties"><code>cas.audit.alternateClientAddrHeaderName=X-Forwarded-For
cas.authn.mfa.groovyScript=file:/path/to/GroovyScript.groovy
</code></pre>
<p>Here, we are teaching CAS to use the <code>X-Forwarded-For</code> header when fetching client IP addresses, and we are also indicating a reference path to our yet-to-be-written Groovy script.</p>
<p>The script itself would have the following structure:</p>
<pre lang="groovy"><code>import java.util.*
import org.apereo.inspektr.common.web.*;

class GroovyMfaScript {

    String privateIPPattern = "(^127\\.0\\.0\\.1)";
    String mfaGroupPattern = "CN=MFA-Enabled";
    String servicePattern = "https://app.example.org";

    def String run(final Object... args) {
        def service = args[0];
        def registeredService = args[1];
        def authentication = args[2];
        def logger = args[3];

        if (service.id.contains(servicePattern)) {
            def clientInfo = ClientInfoHolder.getClientInfo();
            def clientIp = clientInfo.getClientIpAddress();
            logger.info("Client IP [{}]", clientIp);
            if (clientIp.find(privateIPPattern)) {
                logger.info("Internal IP address");

                def memberOf = authentication.principal.attributes['memberOf']
                for (String group : memberOf) {
                    if (group.contains(mfaGroupPattern)) {
                        logger.info("In MFA group");
                        return "mfa-duo";
                    }
                }
                return null;
            }
            return "mfa-duo";
        }
        return null;
    }
}
</code></pre>
<p>The above script goes through the following conditions:</p>
<ul>
<li>The requesting application is <code>https://app.example.org</code>.</li>
<li>The incoming client IP address matches the pattern <code>(^127\\.0\\.0\\.1)</code>.</li>
<li>The authenticated user carries a <code>memberOf</code> attribute with a value of <code>CN=MFA-Enabled</code>.</li>
</ul>
<p>If all of those conditions are true, then MFA is activated...or else ignored. Note that the function of a Groovy trigger is not specific to a multifactor authentication provider. So long as the conditions execute correctly and the provider is configured properly, it can be used to signal any provider back to the authentication flow.</p>
<h2>
<a id="finale" class="anchor" href="#finale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finale</h2>
<p>Thanks to Keith Conger of Colorado College who was kind enough to share the above integration notes.</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>