<hr>
<h2>
<a id="layout-----posttitle------apereo-cas---saml2-metadata-overridessummary----learn-how-to-manage-saml2-service-provider-registrations-in-cas-and-override-metadata-artifacts-on-a-per-application-basistags-------cas" class="anchor" href="#layout-----posttitle------apereo-cas---saml2-metadata-overridessummary----learn-how-to-manage-saml2-service-provider-registrations-in-cas-and-override-metadata-artifacts-on-a-per-application-basistags-------cas" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>layout:     post<br>
title:      Apereo CAS - SAML2 Metadata Overrides<br>
summary:    Learn how to manage SAML2 service provider registrations in CAS and override metadata artifacts on a per-application basis.<br>
tags:       [CAS]</h2>
<!-- raw HTML omitted -->
<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>
<p>One of the more recent additions to CAS, as a SAML2 identity provider, is the ability to override the identity provider metadata and keys on a per-service basis. This capability has been extended to support all identity provider metadata sources and storage services<br>
beyond the typical file system. To keep things simple in this blog post, we are going to focus on a sample SAML2 service provider integration<br>
backed by CAS as a SAML2 identity provider whose metadata (and all other overrides) are managed by the filesystem.</p>
<p>Our starting position is based on:</p>
<ul>
<li>CAS <code>6.2.x</code>
</li>
<li>Java <code>11</code>
</li>
<li><a href="https://github.com/apereo/cas-overlay-template">CAS WAR Overlay</a></li>
</ul>
<h1>
<a id="the-basics" class="anchor" href="#the-basics" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Basics</h1>
<p>Start with the <a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a>, clone the project and follow <a href="https://apereo.github.io/cas/development/installation/Configuring-SAML2-Authentication.html">the notes here</a> to get CAS acting as SAML2 identity provider. In its simplest form, it comes to<br>
down to the following settings:</p>
<pre lang="properties"><code>cas.authn.samlIdp.entityId=https://sso.example.org/idp
cas.authn.samlIdp.scope=example.org
cas.authn.samlIdp.metadata.location=file:/etc/cas/config/saml
</code></pre>
<p>...and this module in the CAS build:</p>
<pre lang="gradle"><code>implementation "org.apereo.cas:cas-server-support-saml-idp:${project.'cas.version'}"
</code></pre>
<p>Note how identity provider artifacts such as metadata and keys are backed by the filesystem and stored inside the <code>/etc/cas/config/saml</code>:</p>
<pre lang="bash"><code>$ ls /etc/cas/saml/ 

Permissions Size User   Group Date Modified Name 
-------------------------------------------------
.rw-r--r--  1.1k Misagh wheel  1 Dec 17:45  idp-encryption.crt
.rw-r--r--  1.7k Misagh wheel  1 Dec 17:45  idp-encryption.key
.rw-r--r--  8.1k Misagh wheel  1 Dec 17:45  idp-metadata.xml
.rw-r--r--  1.1k Misagh wheel  1 Dec 17:45  idp-signing.crt
.rw-r--r--  1.7k Misagh wheel  1 Dec 17:45  idp-signing.key
</code></pre>
<p>Next, we could use <a href="https://apereo.github.io/cas/development/services/JSON-Service-Management.html">JSON service registry</a> to manage<br>
our SAML2 service provider definitions. Here is what our service definition might look like for<br>
SAML2 service provider in a <code>SAML-1.json</code> file:</p>
<pre lang="json"><code>{
  "@class": "org.apereo.cas.support.saml.services.SamlRegisteredService",
  "serviceId": "sp.example.org",
  "name": "Example",
  "id": 1,
  "evaluationOrder": 1,
  "metadataLocation": "/sample/metadata/sp-metadata.xml"
}      
</code></pre>
<h1>
<a id="overrides" class="anchor" href="#overrides" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overrides</h1>
<p>Let's say our service provider wanted to use a different set of signing keys, encryption keys or metadata completely separate from the global SAML2<br>
artifacts listed above. Since we are using the filesystem, these overriding artifacts are expected to be found at <code>/etc/cas/config/saml/Example</code>. The formula is, you should create a directory using the name of your service definition (i.e. <code>Example</code>) and this directly should be created inside the canonical global SAML2 metadata directory.</p>
<pre lang="bash"><code>$ tree /etc/cas/saml/
/etc/cas/saml/
├── Example
│   ├── idp-encryption.crt
│   ├── idp-encryption.key
│   ├── idp-metadata.xml
│   ├── idp-signing.crt
│   └── idp-signing.key
├── idp-encryption.crt
├── idp-encryption.key
├── idp-metadata.xml
├── idp-signing.crt
└── idp-signing.key
</code></pre>
<p>Note that you do not have to override every single certificate and/or artifact. Depending on the use case, you may be quite selective in choosing<br>
the appropriate file for overrides. The bottom line is, if an override is found for a service provider it would be used in combination with everything else.<br>
If there are no overrides, then the global artifact would be used for the requested operation.</p>
<p>Furthermore, note that the <code>/idp/metadata</code> endpoint does also accept a <code>service</code> parameter either by entity id or numeric identifier. This parameter<br>
is matched against the CAS service registry allowing the endpoint to calculate and combine any identity provider metadata overrides that may have been specified.</p>
<h1>
<a id="so" class="anchor" href="#so" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>So...</h1>
<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please know that all other use cases, scenarios, features, and theories certainly <a href="https://apereo.github.io/2017/02/18/onthe-theoryof-possibility/">are possible</a> as well. Feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>
<p>Finally, if you benefit from Apereo CAS as free and open-source software, we invite you to <a href="https://www.apereo.org/content/apereo-membership">join the Apereo Foundation</a> and financially support the project at a capacity that best suits your deployment. If you consider your CAS deployment to be a critical part of the identity and access management ecosystem and care about its long-term success and sustainability, this is a viable option to consider.</p>
<p>Happy Coding,</p>
<p><a href="https://fawnoos.com">Misagh Moayyed</a></p>